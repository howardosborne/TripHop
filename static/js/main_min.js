var map,sidePanel,popup,inspiredTrips,agencyLookup,freestyleStartPoints,possibleHops,candidateHop,hops,routeLines,possibleInspiredTrip,possibleInspiredTripRouteLines,possibleFromToStartPoints,possibleFromToEndPoints,fromToStartPoint,fromToDestination,fromToLines,liveRouteLines,liveStops,all_places={},all_hops={},trips={},stopsPlacesLookup={},lastScrollTop={},lastTab="tab-home";function startUp(){map=L.map("map").setView([45,10],5);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(map);L.control.scale({position:"topleft"}).addTo(map),L.control.zoom({position:"bottomright"}).addTo(map),sidePanel=L.control.sidepanel("mySidepanelLeft",{tabsPosition:"top",startTab:"tab-home"}).addTo(map),freestyleStartPoints=L.markerClusterGroup({maxClusterRadius:40}),possibleHops=L.markerClusterGroup({maxClusterRadius:40}),hops=new L.LayerGroup,routeLines=new L.LayerGroup,possibleFromToStartPoints=L.markerClusterGroup({maxClusterRadius:40}),possibleFromToEndPoints=L.markerClusterGroup({maxClusterRadius:40}),fromToStartPoint=new L.LayerGroup,fromToDestination=new L.LayerGroup,fromToLines=new L.LayerGroup,possibleInspiredTrip=new L.LayerGroup,possibleInspiredTripRouteLines=new L.LayerGroup,liveStops=L.markerClusterGroup({maxClusterRadius:40}),liveRouteLines=new L.LayerGroup,L.easyButton('<img src="./static/icons/resize.png">',(function(e,a){a.fitBounds(possibleHops.getBounds())})).addTo(map),getAllPlaces(),getAgencyLookup(),getInspiredTrips(),showHomeTab()}function getAllPlaces(){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(all_places=JSON.parse(this.responseText),getAllHopsandShowPlaceMarkers())},e.open("GET","./static/places.json",!0),e.send()}function getAllHopsandShowPlaceMarkers(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);all_hops=e,addFreestyleStartPoints(),setupFromToOptions(),addLiveStartPoints()}},e.open("GET","./static/hops.json",!0),e.send()}function addFreestyleStartPoints(){Object.entries(all_places).forEach((e=>{const[a,t]=e;if(a in all_hops){let e=L.icon({iconUrl:"./static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),a=L.marker([t.place_lat,t.place_lon],{icon:e});a.bindTooltip(decodeURI(t.place_name)),a.properties=t,a.addEventListener("click",_starterMarkerOnClick),a.addTo(freestyleStartPoints)}}))}function setupFromToOptions(){placeSelect={},Object.entries(all_places).forEach((e=>{const[a,t]=e;a in all_hops&&(t.place_country in placeSelect?placeSelect[t.place_country].push(t):placeSelect[t.place_country]=[t])}));let e={},a={results:[],pagination:{more:!0}};Object.entries(placeSelect).forEach((t=>{const[o,s]=t;let i={text:o,children:[]};e+=`<optgroup label="${o}">`;for(let a=0;a<s.length;a++)i.children.push({id:s[a].place_id,text:s[a].place_name}),e+=`<option value="${s[a].place_id}">${s[a].place_name}</option>`;e+="</optgroup>",a.results.push(i)})),document.getElementById("destinationSelect").innerHTML=e,document.getElementById("destinationSelect").value="spain_1",document.getElementById("startSelect").innerHTML=e,document.getElementById("startSelect").value="uk_1",addPossibleFromToStartPoints(),addDestinationMarkers()}function addPossibleFromToStartPoints(){Object.entries(all_places).forEach((e=>{const[a,t]=e;if(a in all_hops){let e=L.icon({iconUrl:"./static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),a=L.marker([t.place_lat,t.place_lon],{icon:e});a.bindTooltip(decodeURI(t.place_name)),a.properties=t,a.addEventListener("click",_fromMarkerOnClick),a.addTo(possibleFromToStartPoints)}}))}function addDestinationMarkers(){Object.entries(all_places).forEach((e=>{const[a,t]=e;if(a in all_hops){let e=L.icon({iconUrl:"./static/icons/destination.png",iconSize:[36,36],iconAnchor:[18,36]}),a=L.marker([t.place_lat,t.place_lon],{icon:e});a.bindTooltip(decodeURI(t.place_name)),a.properties=t,a.addEventListener("click",_destinationMarkerOnClick),a.addTo(possibleFromToEndPoints)}}))}function showPossibleFromToStartPoints(){map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(possibleFromToStartPoints)||map.addLayer(possibleFromToStartPoints)}function showPossibleFromToEndPoints(){map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)||map.addLayer(possibleFromToEndPoints)}function addLiveStartPoints(){Object.entries(all_places).forEach((e=>{const[a,t]=e;let o=L.icon({iconUrl:"./static/icons/departure_board.png",iconSize:[24,24],iconAnchor:[12,24]}),s=L.marker([t.place_lat,t.place_lon],{icon:o});s.bindTooltip(decodeURI(t.place_name)),s.properties=t,s.addEventListener("click",_showLiveOnClick),s.addTo(liveStops)}))}function hideSidepanal(){var e=document.getElementById("mySidepanelLeft");e.classList.contains("opened")?(e.classList.remove("opened"),e.classList.add("closed")):e.classList.add("closed")}function showSidepanelTab(e){var a=document.getElementById("mySidepanelLeft");a.classList.contains("closed")?(a.classList.remove("closed"),a.classList.add("opened")):a.classList.add("opened");for(var t=document.getElementsByClassName("sidebar-tab-link"),o=0;o<t.length;o++)t[o].classList.contains("active")&&t[o].classList.remove("active");for(o=0;o<t.length;o++)t[o].attributes["data-tab-link"].value==e&&(t[o].classList.contains("active")||t[o].classList.add("active"));for(t=document.getElementsByClassName("sidepanel-tab-content"),o=0;o<t.length;o++)t[o].classList.contains("active")&&(lastScrollTop[t[o].attributes["data-tab-content"].value]=document.getElementsByClassName("sidepanel-content-wrapper")[0].scrollTop,lastTab=t[o].attributes["data-tab-content"].value,t[o].classList.remove("active"));for(o=0;o<t.length;o++)t[o].attributes["data-tab-content"].value==e&&(t[o].classList.contains("active")||(t[o].classList.add("active"),document.getElementsByClassName("sidepanel-content-wrapper")[0].scrollTop=e in lastScrollTop?lastScrollTop[e]:0))}function getAgencyLookup(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);agencyLookup=e}},e.open("GET","./static/agency_lookup.json",!0),e.send()}function getInspiredTrips(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);inspiredTrips=e,Object.entries(inspiredTrips).forEach((e=>{const[a,t]=e;var o=`\n      <div class="col">\n      <div class="card">\n        <img src="${t.trip_image}" class="card-img-top" alt="...">\n        <div class="card-img-overlay">\n          <a href="#" class="triptitle" onclick="showInspiredRoute('${a}')">${t.trip_title}</a>\n        </div>\n        <div class="card-body">\n          <p class="card-text">${t.trip_description}</p>\n        </div>\n      </div>\n      </div>\n      `;document.getElementById("inspireBody").insertAdjacentHTML("beforeend",o)}))}},e.open("GET","./static/trips.json",!0),e.send()}function zoomToPlace(e){place=all_places[e],map.flyTo([place.place_lat,place.place_lon],9)}function showTripParts(e){document.getElementById("inspireDetailsBody").innerHTML="",document.getElementById("inspireTitle").innerHTML=inspiredTrips[e].trip_title;for(var a=inspiredTrips[e].hops,t=0;t<a.length;t++){place=all_places[a[t].place_id];var o=`\n    <div class="card mb-3">\n      <img src="${a[t].hop_image}" class="img-fluid rounded-start" alt="..." title="${a[t].hop_image_attribution}">\n      <div class="card-text">\n      \x3c!--<h4 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${place.place_name}</h4>--\x3e\n      <a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff";" onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a>\n      <p class="card-text">${a[t].hop_description}</p>\n      <a target="_blank" href="${a[t].link}">${a[t].link_text}</a>\n      </div>\n    </div>`;document.getElementById("inspireDetailsBody").insertAdjacentHTML("beforeend",o)}showSidepanelTab("tab-inspire-details")}function showHomeTab(){map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)&&map.removeLayer(fromToStartPoint),map.hasLayer(fromToDestination)&&map.removeLayer(fromToDestination),map.hasLayer(fromToLines)&&map.removeLayer(fromToLines),map.hasLayer(possibleInspiredTrip)&&map.removeLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)&&map.removeLayer(possibleInspiredTripRouteLines),map.hasLayer(liveStops)&&map.removeLayer(liveStops),map.hasLayer(liveRouteLines)&&map.removeLayer(liveRouteLines),hops.getLayers().length>0?(buildSummary(),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)||map.addLayer(possibleHops),map.hasLayer(hops)||map.addLayer(hops),map.hasLayer(routeLines)||map.addLayer(routeLines),document.getElementById("homeWelcome").hidden=!0,document.getElementById("freestyleBody").hidden=!1):(map.hasLayer(freestyleStartPoints)||map.addLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),document.getElementById("homeWelcome").hidden=!1,document.getElementById("freestyleBody").hidden=!0),showSidepanelTab("tab-home")}function showInspireTab(){map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)&&map.removeLayer(fromToStartPoint),map.hasLayer(fromToDestination)&&map.removeLayer(fromToDestination),map.hasLayer(fromToLines)&&map.removeLayer(fromToLines),map.hasLayer(liveStops)&&map.removeLayer(liveStops),map.hasLayer(liveRouteLines)&&map.removeLayer(liveRouteLines),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),map.hasLayer(possibleInspiredTrip)||map.addLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)||map.addLayer(possibleInspiredTripRouteLines),showSidepanelTab("tab-inspire")}function showDestinationTab(){0==fromToLines.getLayers().length?map.hasLayer(possibleFromToStartPoints)||map.addLayer(possibleFromToStartPoints):(map.hasLayer(fromToStartPoint)||map.addLayer(fromToStartPoint),map.hasLayer(fromToDestination)||map.addLayer(fromToDestination),map.hasLayer(fromToLines)||map.addLayer(fromToLines)),map.hasLayer(liveStops)&&map.removeLayer(liveStops),map.hasLayer(liveRouteLines)&&map.removeLayer(liveRouteLines),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),map.hasLayer(possibleInspiredTrip)&&map.removeLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)&&map.removeLayer(possibleInspiredTripRouteLines),showSidepanelTab("tab-destination")}function showLiveTab(){map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)&&map.removeLayer(fromToStartPoint),map.hasLayer(fromToDestination)&&map.removeLayer(fromToDestination),map.hasLayer(fromToLines)&&map.removeLayer(fromToLines),map.hasLayer(liveRouteLines)||map.addLayer(liveRouteLines),map.hasLayer(liveStops)||map.addLayer(liveStops),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),map.hasLayer(possibleInspiredTrip)&&map.removeLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)&&map.removeLayer(possibleInspiredTripRouteLines),showSidepanelTab("tab-live-departures")}function _starterMarkerOnClick(e){hops.clearLayers(),routeLines.clearLayers();var a=L.icon({iconUrl:"./static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),t=L.marker([e.latlng.lat,e.latlng.lng],{icon:a});t.properties=e.sourceTarget.properties,t.properties.hop_count=1,t.bindTooltip(t.properties.place_name),t.addTo(hops),getHops(e.sourceTarget.properties.place_id),showHomeTab()}function _markerOnClick(e){candidateHop=e.sourceTarget.properties,place=all_places[candidateHop.place_id];var a=get_place_details_block(candidateHop.place_id);document.getElementById("place_body").innerHTML=a;var t=get_travel_details_block(candidateHop.details);document.getElementById("travel_details_body").innerHTML=t,popup_text=`\n    <div class="card mb-3">\n     <img src="${place.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="..." title = "${place.image_attribution}">\n     <div class="card-img-overlay">\n       <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-3"><button type="button" class="btn btn-success btn-sm" onclick="_addToTrip()">Add</button></div></div>\n     </div>\n     <ul class="list-group list-group-flush">\n      <li class="list-group-item">${decodeURIComponent(place.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>\n      <li class="list-group-item">Journey times from: ${format_duration(candidateHop.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>\n     </ul>\n    </div>`,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _addToTrip(){var e;popup&&popup.close(),hops_items=hops.getLayers(),e=all_places[hops_items[hops_items.length-1].properties.place_id],pointA=new L.LatLng(parseFloat(e.place_lat),parseFloat(e.place_lon)),pointB=new L.LatLng(parseFloat(candidateHop.place_lat),parseFloat(candidateHop.place_lon));var a=[pointA,pointB];new_line=new L.Polyline(a,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1}),new_line.addTo(routeLines);var t=L.icon({iconUrl:"./static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]}),o=L.marker([parseFloat(candidateHop.place_lat),parseFloat(candidateHop.place_lon)],{icon:t});hop=all_places[candidateHop.place_id],o.properties=hop,o.properties.from_place_id=e.place_id,o.properties.hop_count=hops_items.length+1,o.bindTooltip(hop.place_name),o.addEventListener("click",_hopOnClick),o.addTo(hops),getHops(candidateHop.place_id),buildSummary()}function _hopOnClick(e){var a=e.sourceTarget.properties;place=all_places[a.place_id];var t=get_place_details_block(place.place_id);document.getElementById("place_body").innerHTML=t;var o=get_travel_details(a.from_place_id,a.place_id),s=get_travel_details_block(o.details);document.getElementById("travel_details_body").innerHTML=s,popup_text=`\n  <div class="card mb-3">\n  <img src="${place.place_image}" class="img-fluid rounded-start" alt="..." title = "${place.image_attribution}">\n  <div class="card-img-overlay">\n    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-4"><button type="button" class="btn btn-success btn-sm" onclick="_addToTrip()">Add</button></div></div>\n  </div>\n  <ul class="list-group list-group-flush">\n   <li class="list-group-item">${decodeURIComponent(place.place_brief_desc)} <a data-bs-toggle="offcanvas" href="#offcanvasPlace" aria-controls="offcanvasPlace"> more...</a></li>\n   <li class="list-group-item">Journey times from: ${format_duration(o.duration_min)} <a data-bs-toggle="offcanvas" href="#offcanvasTravelDetails" aria-controls="offcanvasTravelDetails"> more...</a></li>\n  </ul>\n </div>\n  `,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _inspireHopOnClick(e){var a=e.sourceTarget.properties;place=all_places[a.place_id];var t=get_place_details_block(place.place_id);document.getElementById("place_body").innerHTML=t;var o=get_travel_details(a.from_place_id,a.place_id),s=get_travel_details_block(o.details);if(document.getElementById("travel_details_body").innerHTML=s,a.next_hop_index==possibleInspiredTrip.getLayers().length)var i=`<button class="btn btn-success btn-sm" onclick="customise('${a.trip_id}')">Add hop</button>`;else i=`<button class="btn btn-success btn-sm" onclick="showInspiredHop(${a.next_hop_index})">Next</button>`;popup_text=`\n\n  <div class="card mb-3">\n  <img src="${a.hop_image}" class="img-fluid rounded-start" style="max-height:250px" alt="..." title = "${a.hop_image_attribution}">\n  <div class="card-img-overlay">\n    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-4">${i}</div></div>\n  </div>\n  <ul class="list-group list-group-flush">\n   <li class="list-group-item">${a.hop_description} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>\n   <li class="list-group-item">Journey times from: ${format_duration(o.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>\n  </ul>\n </div>\n  `,popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function _startInspireHopOnClick(e){var a=e.sourceTarget.properties,t=`<button class="btn btn-success btn-sm" onclick="showInspiredHop(${a.next_hop_index})">Next</button>`;place=all_places[a.place_id];var o=get_place_details_block(place.place_id);document.getElementById("place_body").innerHTML=o,popup_text=`\n  <div class="card mb-3">\n  <img src="${a.hop_image}" class="img-fluid rounded-start" style="max-height:250px" alt="..." title = "${a.hop_image_attribution}">\n  <div class="card-img-overlay">\n    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-4">${t}</div></div>\n  </div>\n  <ul class="list-group list-group-flush">\n   <li class="list-group-item">${a.hop_description}</li>\n  </ul>\n </div>\n    `,popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function showInspiredHop(e){possibleInspiredTrip.getLayers()[e].fireEvent("click")}function get_place_details_block(e){return`<h3 class="offcanvas-title" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${all_places[e].place_name}</h3>\n  <div class="card">\n    <img src="${all_places[e].place_image}" class="card-img-top" alt="${all_places[e].place_name}" title="all_places[id]["image_attribution"]">\n    <div class="card-body">\n      <p class="card-text">${all_places[e].place_longer_desc}</p>\n\t  <a href="${all_places[e].place_links}" target="_blank" class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">more info</a>\n    </div>\n    <div class="accordion accordion-flush" id="accordionPlaceDetails">\n      <div class="accordion-item">\n        <h2 class="accordion-header">\n          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">\n            Things to do\n          </button>\n        </h2>\n        <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">\n          <div class="accordion-body">\n\t\t  <p class="card-text">If you'd like to see what there is to see and do, here are some sites with ideas.</p>\n          <ul class="list-group list-group-flush">\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://tripadvisor.tp.st/iaDPCVsJ" target="_blank">TripAdvisor</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://viator.tp.st/dxbdWqWw" target="_blank">Viator</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://getyourguide.tp.st/j1O2V9WC" target="_blank">GetYourGuide</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://gocity.tp.st/bJKfnqLg" target="_blank">Go City</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://bikesbooking.tp.st/hzrEGoUL" target="_blank">BikesBooking.com</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://wegotrip.tp.st/9RusUZKl" target="_blank">WeGoTrip</a></li>\n          </ul>\n          </div>\n        </div>\n      </div>\n      <div class="accordion-item">\n        <h2 class="accordion-header">\n          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">\n            Places to stay\n          </button>\n        </h2>\n        <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">\n          <div class="accordion-body">\n\t\t\t    <p class="card-text">Here are some links to sites where you can find a place to stay.</p>\n          <ul class="list-group list-group-flush">\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://booking.tp.st/JFpi36Ld/" target="_blank">Booking.com</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://vrbo.tp.st/V3hK9T1Z" target="_blank">Vrbo</a></li>\n          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://hostelworld.tp.st/kXriQ07L" target="_blank">Hostelworld</a></li>\n          </ul>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>`}function get_travel_details_block(e){return details_list='<ul class="list-group list-group-flush">',e.forEach((function(e){agency_name=e.agency_name,agency_name in agencyLookup?agency_url=agencyLookup[agency_name]:agency_url="https://omio.tp.st/p3bESwp0",transport_type=e.mode,details_list+=`\n    <li class="list-group-item">\n      <div class="row g-0">\n        <div class="col-md-4">\n          <img src="./static/icons/${transport_type}.png" class="img-fluid rounded-start" alt="...">\n        </div>\n        <div class="col-md-8">\n          <div class="card-body">\n            <h5 class="card-title"><a target="_blank" href="${agency_url}" >${agency_name}</a></h5>\n            <p class="card-text"><small class="text-body-secondary">Journey time: ${format_duration(e.duration_min)}</small></p>\n            </div>\n        </div>\n      </div>     \n    </li>`})),details_list+="</ul>",details_list}function get_travel_details(e,a){var t;return all_hops[e].hops.forEach((e=>{e.place_id==a&&(t=e)})),t}function sortNextHops(e,a){return parseFloat(e.properties.duration_min)<parseFloat(a.properties.duration_min)?-1:parseFloat(e.properties.duration_min)>parseFloat(a.properties.duration_min)?1:0}function getHops(e){possibleHops.clearLayers();let a=all_hops[e].hops;Object.entries(a).forEach((e=>{const[a,t]=e;let o=L.icon({iconUrl:"./static/icons/hop.png",iconSize:[36,36],iconAnchor:[18,36]}),s=L.marker([t.place_lat,t.place_lon],{icon:o});s.bindTooltip(`${t.place_name}: ${format_duration(t.duration_min)}`),s.properties=t,s.addEventListener("click",_markerOnClick),s.riseOnHover=!0,s.addTo(possibleHops)}))}function removeHop(e){popup&&popup.close();for(var a=(o=hops.getLayers()).length,t=e;t<a;t++)h=hops.getLayers(),hops.removeLayer(h[h.length-1]._leaflet_id),layers=routeLines.getLayers(),routeLines.removeLayer(layers[layers.length-1]._leaflet_id);var o,s=(o=hops.getLayers())[o.length-1].properties.place_id;possibleHops.clearLayers(),getHops(s),buildSummary()}function format_duration(e){return remainder=e%60,str_remainder=remainder.toString(),hours=(e-remainder)/60,hours.toString()+":"+str_remainder.padStart(2,"0")}function openTravelDetails(e,a){var t=get_travel_details_block(get_travel_details(e,a).details);document.getElementById("travel_details_body").innerHTML=t,showSidepanelTab("tab-travel-details")}function openPlaceDetails(e){place=all_places[e];var a=get_place_details_block(place.place_id);document.getElementById("place_body").innerHTML=a,showSidepanelTab("tab-place")}function showInspiredRoute(e){possibleInspiredTrip.clearLayers(),possibleInspiredTripRouteLines.clearLayers();var a=inspiredTrips[e].hops,t=all_places[a[0].place_id],o=L.icon({iconUrl:"./static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),s=L.marker([parseFloat(t.place_lat),parseFloat(t.place_lon)],{icon:o});s.bindTooltip(decodeURI(t.place_name)),t.hop_image=a[0].hop_image,t.hop_image_attribution=a[0].hop_image_attribution,t.hop_description=a[0].hop_description,t.link=a[0].link,t.link_text=a[0].link_text,t.trip_id=e,t.next_hop_index=1,s.properties=t,s.addEventListener("click",_startInspireHopOnClick),s.riseOnHover=!0,s.addTo(possibleInspiredTrip);for(var i=1;i<a.length;i++){(t=all_places[a[i].place_id]).from_place_id=a[i-1].place_id,t.hop_count=i;o=L.icon({iconUrl:"./static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]});var n=L.marker([parseFloat(t.place_lat),parseFloat(t.place_lon)],{icon:o});n.bindTooltip(t.place_name),t.hop_image=a[i].hop_image,t.hop_image_attribution=a[i].hop_image_attribution,t.hop_description=a[i].hop_description,t.link=a[i].link,t.link_text=a[i].link_text,t.trip_id=e,t.next_hop_index=i+1,n.properties=t,n.addEventListener("click",_inspireHopOnClick),n.riseOnHover=!0,n.addTo(possibleInspiredTrip),pointA=new L.LatLng(parseFloat(all_places[a[i-1].place_id].place_lat),parseFloat(all_places[a[i-1].place_id].place_lon)),pointB=new L.LatLng(parseFloat(all_places[a[i].place_id].place_lat),parseFloat(all_places[a[i].place_id].place_lon));var l=[pointA,pointB];new_line=new L.Polyline(l,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1}),new_line.addTo(possibleInspiredTripRouteLines)}hideSidepanal(),showTripParts(e)}function customise(e){useThisRoute(e)}function useThisRoute(e){hops.clearLayers(),routeLines.clearLayers(),popup&&popup.close();var a=inspiredTrips[e].hops,t=all_places[a[0].place_id],o=L.icon({iconUrl:"./static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]});(i=L.marker([parseFloat(t.place_lat),parseFloat(t.place_lon)],{icon:o})).bindTooltip(decodeURI(t.place_name)),i.properties=t,i.riseOnHover=!0,i.addTo(hops);for(var s=1;s<a.length;s++){(t=all_places[a[s].place_id]).from_place_id=a[s-1].place_id,t.hop_count=s;var i;o=L.icon({iconUrl:"./static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]});(i=L.marker([parseFloat(t.place_lat),parseFloat(t.place_lon)],{icon:o})).bindTooltip(t.place_name),i.properties=t,i.addEventListener("click",_hopOnClick),i.riseOnHover=!0,i.addTo(hops),pointA=new L.LatLng(parseFloat(all_places[a[s-1].place_id].place_lat),parseFloat(all_places[a[s-1].place_id].place_lon)),pointB=new L.LatLng(parseFloat(all_places[a[s].place_id].place_lat),parseFloat(all_places[a[s].place_id].place_lon));var n=[pointA,pointB];new_line=new L.Polyline(n,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1}),new_line.addTo(routeLines)}getHops(a[a.length-1].place_id),possibleInspiredTrip.clearLayers(),possibleInspiredTripRouteLines.clearLayers(),showHomeTab()}function startAgain(){document.getElementById("freestyleBody").innerHTML="",hops.clearLayers(),routeLines.clearLayers(),possibleHops.clearLayers(),showHomeTab()}function showLiveStops(){}function buildSummary(){let e=hops.getLayers();document.getElementById("freestyleBody").innerHTML=`<div class="row justify-content-evenly"><div class="col-7"><h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">Starting at ${e[0].properties.place_name}</h5></div><div class="col" style="float: right;"><button style="float: right;" class="btn btn-outline-success btn-sm" onclick="startAgain()">start again</button></div></div>`;for(let a=1;a<e.length;a++){let t="";a==e.length-1&&(t=`<button class="btn btn-danger btn-sm" onclick="removeHop('${a}')">remove</button>`),document.getElementById("freestyleBody").innerHTML+=`\n    <div class="card border-light mb-3 ">\n    <div class="row g-0">\n      <div class="col-md-12">\n        <img src="./static/icons/train.png" class="img-fluid rounded-start" alt="...">\n        <a href="#" class="link-dark link-offset-2" onclick="openTravelDetails('${e[a-1].properties.place_id}','${e[a].properties.place_id}')">${e[a-1].properties.place_name} to ${e[a].properties.place_name} travel options</a>\n       </div>\n    </div>\n  </div>`,document.getElementById("freestyleBody").innerHTML+=`\n    <div class="card">\n     <img src="${e[a].properties.place_image}" class="img-fluid rounded-start" alt="..." title = "${e[a].properties.image_attribution}" onclick="popAndZoom('${e[a].properties.place_id}')">\n     <div class="card-img-overlay">\n     <div class="row justify-content-evenly"><div class="col"><a href="#" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="popAndZoom('${e[a].properties.place_id}')">${e[a].properties.place_name}</a></div><div class="col-4">${t}</div></div>\n    </div>\n    </div>`}1==e.length&&(document.getElementById("freestyleBody").innerHTML+=`<h6 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff" >Where next?</h6>\n    <p class="text-center">Pick a place to hop to from ${e[0].properties.place_name}.</p>`);let a=possibleHops.getLayers();a.sort(sortNextHops);let t='<div class="card"><div class="card-header">Where next?</div><div class="card-body">';for(let o=0;o<a.length;o++)t+=`\n      <div class="row justify-content-evenly">\n      <div class="col">   \n        <a href="#" onclick="popupHop('${a[o].properties.place_id}')">${a[o].properties.place_name}</a>\n      </div>\n      <div class="col">   \n        <a href="#" onclick="openTravelDetails('${e[e.length-1].properties.place_id}','${a[o].properties.place_id}')">travel time: ${format_duration(Math.round(a[o].properties.duration_min))}</a>\n      </div>    \n      </div>`;t+="</div></div>",document.getElementById("freestyleBody").insertAdjacentHTML("beforeend",t)}function popAndZoom(e){zoomToPlace(e),openPlaceDetails(e)}function showWholeInspiredRoute(){map.fitBounds([possibleInspiredTrip.getLayers()[0].getLatLng(),possibleInspiredTrip.getLayers()[possibleInspiredTrip.getLayers().length-1].getLatLng()])}function showWholeMap(){map.fitBounds(possibleHops)}function popupHop(e){let a=possibleHops.getLayers();for(let t=0;t<a.length;t++)a[t].properties.place_id==e&&(candidateHop=a[t].properties);place=all_places[candidateHop.place_id];var t=get_place_details_block(candidateHop.place_id);document.getElementById("place_body").innerHTML=t;var o=get_travel_details_block(candidateHop.details);document.getElementById("travel_details_body").innerHTML=o,popup_text=`\n    <div class="card mb-3">\n     <img src="${place.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="..." title = "${place.image_attribution}">\n     <div class="card-img-overlay">\n       <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-3"><button type="button" class="btn btn-success btn-sm" onclick="_addToTrip()">Add</button></div></div>\n     </div>\n     <ul class="list-group list-group-flush">\n      <li class="list-group-item">${decodeURIComponent(place.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>\n      <li class="list-group-item">Journey times from: ${format_duration(candidateHop.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>\n     </ul>\n    </div>`,hideSidepanal(),popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function _fromMarkerOnClick(e){candidateHop=e.sourceTarget.properties,place=all_places[candidateHop.place_id];var a=get_place_details_block(candidateHop.place_id);document.getElementById("place_body").innerHTML=a,popup_text=`\n        <p>${place.place_name}</p>\n        <button type="button" style="background-color:#abc837ff" class="btn btn-success btn-sm" onclick="_setStartpoint('${place.place_id}')">Start here</button>`,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _destinationMarkerOnClick(e){candidateHop=e.sourceTarget.properties,place=all_places[candidateHop.place_id];var a=get_place_details_block(candidateHop.place_id);document.getElementById("place_body").innerHTML=a,popup_text=`\n      <p>${place.place_name}</p>\n      <button type="button" style="background-color:#abc837ff" class="btn btn-success btn-sm" onclick="_setDestination('${place.place_id}')">Destination</button>`,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _setStartpoint(e){popup&&popup.close(),map.removeLayer(possibleFromToStartPoints),map.addLayer(possibleFromToEndPoints),document.getElementById("startSelect").value=e}function _setDestination(e){popup&&popup.close(),document.getElementById("destinationSelect").value=e,findFabRoutes()}function _routeHopOnClick(e){var a=e.sourceTarget.properties;place=all_places[a.place_id];var t=get_place_details_block(place.place_id);document.getElementById("place_body").innerHTML=t;var o=get_travel_details(a.from_place_id,a.place_id),s=get_travel_details_block(o.details);document.getElementById("travel_details_body").innerHTML=s,popup_text=`\n  <div class="card mb-3">\n  <img src="${a.hop_image}" class="img-fluid rounded-start" style="max-height:250px" alt="..." title = "${a.hop_image_attribution}">\n  <div class="card-img-overlay">\n    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div></div>\n  </div>\n  <ul class="list-group list-group-flush">\n   <li class="list-group-item">${a.hop_description} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>\n   <li class="list-group-item">Journey times from: ${format_duration(o.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>\n  </ul>\n </div>\n  `,popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function clearAllLayers(){hops.clearLayers(),fromToStartPoint.clearLayers(),fromToDestination.clearLayers(),routeLines.clearLayers(),possibleInspiredTrip.clearLayers(),possibleInspiredTripRouteLines.clearLayers(),possibleHops.clearLayers(),freestyleStartPoints.clearLayers(),possibleFromToStartPoints.clearLayers(),possibleFromToEndPoints.clearLayers(),liveRouteLines.clearLayers(),liveStops.clearLayers()}function toRadians(e){return e*(Math.PI/180)}function distanceBetweenTwoPoints(e,t,o,s){return from_lat_rad=toRadians(parseFloat(e)),from_lon_rad=toRadians(parseFloat(t)),to_lat_rad=toRadians(parseFloat(o)),to_lon_rad=toRadians(parseFloat(s)),dist_lon=to_lon_rad-from_lon_rad,dist_lat=to_lat_rad-from_lat_rad,a=Math.sin(dist_lat/2)**2+Math.cos(from_lat_rad)*Math.cos(to_lat_rad)*Math.sin(dist_lon/2)**2,c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),R=6373,distance=R*c,distance}function findFabRoutes(){popup&&popup.close();let e=document.getElementById("startSelect").value,a=document.getElementById("destinationSelect").value;if(e==a||""==e||""==a)console.log(`dodgy ${e}`);else{map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)||map.addLayer(fromToStartPoint),map.hasLayer(fromToDestination)||map.addLayer(fromToDestination),map.hasLayer(fromToLines)||map.addLayer(fromToLines),fromToStartPoint.clearLayers(),fromToDestination.clearLayers(),fromToLines.clearLayers(),document.getElementById("fromToResults").innerHTML="";let t=L.icon({iconUrl:"./static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),o=L.marker([all_places[e].place_lat,all_places[e].place_lon],{icon:t});o.properties=all_places[e],o.bindTooltip(o.properties.place_name),o.addTo(fromToStartPoint),t=L.icon({iconUrl:"./static/icons/destination.png",iconSize:[36,36],iconAnchor:[18,36]}),o=L.marker([all_places[a].place_lat,all_places[a].place_lon],{icon:t}),o.properties=all_places[a],o.bindTooltip(o.properties.place_name),o.addTo(fromToDestination),findFromStops(e,a)}}function findFromStops(e,a){let t=[],o=all_places[e];var s=`https://v5.db.transport.rest/stops/nearby?latitude=${o.place_lat}&longitude=${o.place_lon}&results=1&distance=${o.lat_lon_tolerance}000&stops=true`,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var o=JSON.parse(this.responseText);console.log("processing stops"),console.log(this.responseText);for(var s=0;s<o.length;s++){const a=o[s];"stop"==a.type&&(stopsPlacesLookup[a.id]=e,console.log(`findFromStops: ${a.id} - ${a.name}`),t.push(a.id))}findToStops(e,a,t[0])}},i.open("GET",s,!0),i.send()}function findToStops(e,a,t){let o=[],s=all_places[a];var i=`https://v5.db.transport.rest/stops/nearby?latitude=${s.place_lat}&longitude=${s.place_lon}&results=1&distance=${s.lat_lon_tolerance}000&stops=true`,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var s=JSON.parse(this.responseText);console.log("processing stops"),console.log(this.responseText);for(var i=0;i<s.length;i++){const e=s[i];"stop"==e.type&&(stopsPlacesLookup[e.id]=a,console.log(`findToStops: ${e.id} - ${e.name}`),o.push(e.id))}getFromTo(e,a,t,o[0])}},n.open("GET",i,!0),n.send()}function getFromTo(e,a,t,o){trips={};var s=`https://v6.db.transport.rest/journeys?from=${t}&to=${o}&results=3&stopovers=false&transferTime=0&bike=false&startWithWalking=true&walkingSpeed=normal&tickets=false&polylines=false&subStops=true&entrances=true&remarks=true&scheduledDays=false&language=en&firstClass=false`,i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var s=JSON.parse(this.responseText);console.log("processing journeys");const l=s.journeys;let r=[];if(0==l.length)document.getElementById("fromToResults").innerHTML="No results found";else for(var i=0;i<l.length;i++){const s=l[i].legs;let p="";for(var n=0;n<s.length;n++)if("line"in s[n]){p+=s[n].line.name}if(r.includes(p))console.log("already included this journey");else{console.log(`new journey ${p}`),document.getElementById("fromToResults").insertAdjacentHTML("beforeend",`<div id="${t}_${o}_${i}"></div>`),document.getElementById(`${t}_${o}_${i}`).insertAdjacentHTML("beforeend",`<h5>Option ${i+1}</h5>`);for(n=0;n<s.length;n++)if(placeNear(s[n].destination.location.latitude,s[n].destination.location.longitude,e))console.log(`${s[n].destination.name} ${e} haven't left start`);else if(placeNear(s[n].origin.location.latitude,s[n].origin.location.longitude,a))console.log("already reached destination");else if("line"in s[n]){let e=s[n].line.name;p+=e;let a=s[n].tripId;e&&(document.getElementById(`${t}_${o}_${i}`).insertAdjacentHTML("beforeend",`<div id="${s[n].origin.id}_${s[n].destination.id}_${i}"></div>`),getTripsForLine(s[n].origin.id,s[n].destination.id,a,e,`${s[n].origin.id}_${s[n].destination.id}_${i}`))}}}}},i.open("GET",s,!0),i.send()}function getTripsForLine(e,a,t,o,s){let i=`https://v5.db.transport.rest/trips/${encodeURI(t)}?lineName=${encodeURI(o)}`,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let n=JSON.parse(this.responseText);if(trips[encodeURI(t)]=n,console.log(`processing trip from ${e} to ${a}`),console.log(o),"stopovers"in n){let o=n.stopovers,l="";if(n.remarks)for(let e=0;e<n.remarks.length;e++)l+=`<br>${n.remarks[e].text}`;let r,p,c="",d=!1,m=[],u=[];for(let t=0;t<o.length;t++){if(0==t?o[t].timestamp=o[t].plannedDeparture:o[t].plannedArrival?o[t].timestamp=o[t].plannedArrival:o[t].timestamp=o[t].plannedDeparture,o[t].stop.id==e&&(d=!0,r=t),d){let e="",a=`showPlaceOnMap('${o[t].stop.location.latitude}', '${o[t].stop.location.longitude}','${o[t].stop.name}')`;Object.entries(all_places).forEach((s=>{const[i,n]=s;distanceBetweenTwoPoints(o[t].stop.location.latitude,o[t].stop.location.longitude,n.place_lat,n.place_lon)<=n.lat_lon_tolerance&&(a=`popupPlace('${n.place_id}')`,u.includes(n.place_id)||u.push(n.place_id),e='<span class="badge text-bg-light">Fab Hop!</span>')})),c+=`<li class="list-group-item"><a href="#" onclick="${a}">${o[t].stop.name} ${e}</a></li>`,m.push([o[t].stop.location.latitude,o[t].stop.location.longitude])}o[t].stop.id==a&&(p=t,d=!1)}u.length>1?badge=`<span class="badge text-bg-light">${u.length} fab hops!</span>`:1==u.length?badge='<span class="badge text-bg-light">1 fab hop!</span>':badge="";let _=`\n        <div class="card">\n          <div class="card-header">\n          <img src="./static/icons/${n.line.mode}.png" class="img-fluid rounded-start" alt="..."> <a data-bs-toggle="collapse" href="#${encodeURI(t)}" aria-expanded="false" aria-controls="${encodeURI(t)}">\n          ${o[r].stop.name} to ${o[p].stop.name}\n          </a> ${badge}\n          </div>\n          <div class="collapse" id="${encodeURI(t)}">\n          <div class="card-body">\n          <ul class="list-group list-group-flush">\n        `;document.getElementById(s).insertAdjacentHTML("beforeend",`${_}${c}</ul></div></div></div>`);var i=L.polyline(m,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1});i.bindTooltip(`${n.origin.name} to ${n.destination.name}`),i.properties=n,i.addTo(fromToLines)}}},n.open("GET",i,!0),n.send()}function getDepartures(e){liveRouteLines.clearLayers(),map.hasLayer(liveRouteLines)||map.addLayer(liveRouteLines);let a=stopsPlacesLookup[e];all_places[a];trips={};var t=`https://v5.db.transport.rest/stops/${e}/departures?duration=1440`,o=new XMLHttpRequest;o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var a=JSON.parse(this.responseText);console.log("processing departures"),console.log(this.responseText);for(var t=0;t<a.length;t++){const o=a[t];trip_id=o.tripId,line_name=o.line.name,getLiveTrips(e,trip_id,line_name)}}},o.open("GET",t,!0),o.send()}function getLiveTrips(e,a,t){let o=`https://v5.db.transport.rest/trips/${encodeURI(a)}?lineName=${encodeURI(t)}`,s=new XMLHttpRequest;s.onreadystatechange=function(){if(4==this.readyState&&200==this.status){let o=JSON.parse(this.responseText);if(trips[encodeURI(a)]=o,console.log("processing trips"),console.log(this.responseText),"stopovers"in o){let s=o.stopovers,i="";if(o.remarks)for(let e=0;e<o.remarks.length;e++)i+=`<br>${o.remarks[e].text}`;let n,l="",r=!1;latlngs=[];for(let a=0;a<s.length;a++){s[a].stop.id==e&&(r=!0,n=a);0==a?s[a].timestamp=s[a].plannedDeparture:s[a].plannedArrival?s[a].timestamp=s[a].plannedArrival:s[a].timestamp=s[a].plannedDeparture,r&&(l+=`<li class="list-group-item">${s[a].timestamp.substring(11,19)}: <a href="#" onclick="showPlaceOnMap('${s[a].stop.location.latitude}', '${s[a].stop.location.longitude}','${s[a].stop.name}')">${s[a].stop.name}</a></li>`,latlngs.push([s[a].stop.location.latitude,s[a].stop.location.longitude]))}if(n){let e=`\n            <div class="card">\n              <div class="card-header livetrip" onmouseover="showTripOnMap('${encodeURI(a)}')" timestamp="${s[n].timestamp.substring(11,19)}">\n              ${s[n].timestamp.substring(11,19)} \n              <a data-bs-toggle="collapse" href="#${encodeURI(a)}" aria-expanded="false" aria-controls="${encodeURI(a)}">\n              ${s[n].stop.name} to ${o.destination.name}\n              </a>\n              </div>\n              <div class="collapse" id="${encodeURI(a)}">\n              <div class="card-body">\n              <p>${o.line.mode}\n              ${i}\n              </p>\n              <ul class="list-group list-group-flush">\n            `;document.getElementById("routes_from_places").insertAdjacentHTML("beforeend",`${e}${l}</ul></div></div></div>`);var t=L.polyline(latlngs,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1});t.bindTooltip(`${o.origin.name} to ${o.destination.name}`),t.properties=o,t.addTo(liveRouteLines)}}}},s.open("GET",o,!0),s.send()}function sortTimetable(){document.getElementsByClassName("livetrip").sort((function(e,a){return e.getAttribute("timestamp")<a.getAttribute("timestamp")?-1:1})),document.getElementById("routes_from_places").html(divList)}function showPlaceOnMap(e,a,t){let o="";Object.entries(all_places).forEach((t=>{const[s,i]=t;distanceBetweenTwoPoints(e,a,i.place_lat,i.place_lon)<=i.lat_lon_tolerance&&(o=`<a href="#" onclick="popupPlace('${i.place_id}')">more...</a>`)}));let s=`<p>${t}<br>${o}</p>`;popup=L.popup().setLatLng([e,a]).setContent(s).openOn(map)}function showTripOnMap(e){let a=trips[e];if("stopovers"in a){let e=a.stopovers;departureTime=e[0].plannedDeparture,latlngs=[];for(let a=0;a<e.length;a++){let t="";e[a].departure&&(t=e[a].departure),t||(t=e[a].arrival),latlngs.push([e[a].stop.location.latitude,e[a].stop.location.longitude])}var t=L.polyline(latlngs,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1});t.bindTooltip(`${a.origin.name} to ${a.destination.name}`),t.properties=a,t.addTo(liveRouteLines)}}function _showLiveOnClick(e){document.getElementById("routes_from_places").innerHTML="",place_id=e.sourceTarget.properties.place_id,place=all_places[place_id];let a=`<h5>Departures from ${place.place_name}</h5>`;document.getElementById("routes_from_places").insertAdjacentHTML("beforeend",a);var t=`https://v5.db.transport.rest/stops/nearby?latitude=${place.place_lat}&longitude=${place.place_lon}&results=10&distance=${place.lat_lon_tolerance}000&stops=true`,o=new XMLHttpRequest;o.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText);console.log("processing stops"),console.log(this.responseText);for(var a=0;a<e.length;a++){const t=e[a];"stop"==t.type&&(stopsPlacesLookup[t.id]=place_id,getDepartures(t.id))}}},o.open("GET",t,!0),o.send()}function popupPlace(e){let a=all_places[e],t=get_place_details_block(e);document.getElementById("place_body").innerHTML=t,popup_text=`\n    <div class="card mb-3">\n     <img src="${a.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="..." title = "${a.image_attribution}">\n     <div class="card-img-overlay">\n       <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${a.place_id}')">${a.place_name}</a></div></div>\n     </div>\n     <ul class="list-group list-group-flush">\n      <li class="list-group-item">${decodeURIComponent(a.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>\n     </ul>\n    </div>`,hideSidepanal(),popup=L.popup().setLatLng([a.place_lat,a.place_lon]).setContent(popup_text).openOn(map)}function placeNear(e,a,t){let o=all_places[t];return distanceBetweenTwoPoints(e,a,o.place_lat,o.place_lon)<=o.lat_lon_tolerance}function revertToPreviousTab(){showSidepanelTab(lastTab)}