var map,sidePanel,popup,settings,startSelect,destinationSelect,inspiredTrips,agencyLookup,journeyLookup,freestyleStartPoints,possibleHops,candidateHop,hops,routeLines,possibleInspiredTrip,possibleInspiredTripRouteLines,possibleFromToStartPoints,possibleFromToEndPoints,fromToStartPoint,fromToDestination,fromToLines,liveRouteLines,liveStops,dbServer="v5.db.transport.rest",all_places={},all_hops={},trips={},stopsPlacesLookup={},stopsForPlaces={},lastScrollTop={},lastTab="tab-home";function startUp(){console.log("href: "+window.location.href),map=L.map("map").setView([45,10],5);L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(map);L.control.scale({position:"topleft"}).addTo(map),L.control.zoom({position:"bottomright"}).addTo(map),sidePanel=L.control.sidepanel("mySidepanelLeft",{tabsPosition:"top",startTab:"tab-home"}).addTo(map),freestyleStartPoints=L.markerClusterGroup({maxClusterRadius:40}),possibleHops=L.markerClusterGroup({maxClusterRadius:40}),hops=new L.LayerGroup,routeLines=new L.LayerGroup,possibleFromToStartPoints=L.markerClusterGroup({maxClusterRadius:40}),possibleFromToEndPoints=L.markerClusterGroup({maxClusterRadius:40}),fromToStartPoint=new L.LayerGroup,fromToDestination=new L.LayerGroup,fromToLines=new L.LayerGroup,possibleInspiredTrip=new L.LayerGroup,possibleInspiredTripRouteLines=new L.LayerGroup,liveStops=L.markerClusterGroup({maxClusterRadius:40}),liveRouteLines=new L.LayerGroup,L.easyButton('<img src="/static/icons/resize.png" alt="resize" title="resize">',function(e,t){t.fitBounds(possibleHops.getBounds())}).addTo(map),getSettings(),getAllPlaces(),getAgencyLookup(),getInspiredTrips(),showHomeTab()}function getSettings(){href=encodeURIComponent(window.location.href),url="https://script.google.com/macros/s/AKfycbyEskUlQxAOp1rXvo40xbyZDQEgiojWiZXBexBGCLyr0ptkz2kT-3vjvXcCwzTH-zPSGg/exec?request=settings&href="+href;var e=new XMLHttpRequest;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(settings=JSON.parse(this.responseText))},e.open("GET",url,!0),e.send()}function getAllPlaces(){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(all_places=JSON.parse(this.responseText),getStopsForPlaces())},e.open("GET","/static/places.json",!0),e.send()}function getStopsForPlaces(){var e=new XMLHttpRequest;e.onreadystatechange=function(){4==this.readyState&&200==this.status&&(stopsForPlaces=JSON.parse(this.responseText),getAllHopsandShowPlaceMarkers())},e.open("GET","/static/stops_for_places.json",!0),e.send()}function getAllHopsandShowPlaceMarkers(){var e=new XMLHttpRequest;e.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(e=JSON.parse(this.responseText),all_hops=e,addFreestyleStartPoints(),setupFromToOptions(),addLiveStops())},e.open("GET","/static/hops.json",!0),e.send()}function addFreestyleStartPoints(){Object.entries(all_places).forEach(e=>{var[e,t]=e;e in all_hops&&(e=L.icon({iconUrl:"/static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),(e=L.marker([t.place_lat,t.place_lon],{icon:e})).bindTooltip(decodeURI(t.place_name)),e.properties=t,e.addEventListener("click",_starterMarkerOnClick),e.addTo(freestyleStartPoints))})}function setupFromToOptions(){placeSelect={},Object.entries(all_places).forEach(e=>{var[e,t]=e;e in stopsForPlaces&&0<stopsForPlaces[e].length&&(t.place_country in placeSelect?placeSelect[t.place_country].push(t):placeSelect[t.place_country]=[t])});let o={},s={data:[]};Object.entries(placeSelect).forEach(e=>{var[e,t]=e,a={label:e,options:[]};o+=`<optgroup label="${e}">`;for(let e=0;e<t.length;e++)a.options.push({value:t[e].place_id,text:t[e].place_name}),o+=`<option value="${t[e].place_id}">${t[e].place_name}</option>`;o+="</optgroup>",s.data.push(a)}),destinationSelect=new SlimSelect({select:"#destinationSelect",data:s.data}),(startSelect=new SlimSelect({select:"#startSelect",data:s.data})).setSelected("uk_1"),destinationSelect.setSelected("spain_1"),addPossibleFromToStartPoints(),addDestinationMarkers()}function addPossibleFromToStartPoints(){Object.entries(all_places).forEach(e=>{var[e,t]=e;e in stopsForPlaces&&0<stopsForPlaces[e].length&&(e=L.icon({iconUrl:"/static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),(e=L.marker([t.place_lat,t.place_lon],{icon:e})).bindTooltip(decodeURI(t.place_name)),e.properties=t,e.addEventListener("click",_fromMarkerOnClick),e.addTo(possibleFromToStartPoints))})}function addDestinationMarkers(){Object.entries(all_places).forEach(e=>{var[e,t]=e;e in stopsForPlaces&&0<stopsForPlaces[e].length&&(e=L.icon({iconUrl:"/static/icons/destination.png",iconSize:[36,36],iconAnchor:[18,36]}),(e=L.marker([t.place_lat,t.place_lon],{icon:e})).bindTooltip(decodeURI(t.place_name)),e.properties=t,e.addEventListener("click",_destinationMarkerOnClick),e.addTo(possibleFromToEndPoints))});var e=window.location.href,t=RegExp(".+action=fromto&from=(\\w+)&to=(\\w+)","g"),a=RegExp(".+action=place&place_id=(\\w+)","g"),o=RegExp(".+action=inspire&id=(\\w+)","g");let s;if(s=t.exec(e))showDestinationTab(),startSelect.setSelected(s[1]),destinationSelect.setSelected(s[2]),findFabRoutes();else if(s=a.exec(e)){let e=s[1];e=e.replace("germany","Germany");t=all_places[e],a=get_place_details_block(e);document.getElementById("place_body").innerHTML=a,popup_text=`
        <div class="card mb-3">
         <img src="${t.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="${t.place_name}" title = "${t.image_attribution}">
         <div class="card-img-overlay">
         <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${t.place_id}')">${t.place_name}</a></div></div>
         </div>
         <ul class="list-group list-group-flush">
          <li class="list-group-item">${decodeURIComponent(t.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
         </ul>
        </div>`,popup=L.popup().setLatLng([t.place_lat,t.place_lon]).setContent(popup_text).openOn(map)}(s=o.exec(e))&&(showInspireTab(),showInspiredRoute(s[1]))}function showPossibleFromToStartPoints(){map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(possibleFromToStartPoints)||map.addLayer(possibleFromToStartPoints)}function showPossibleFromToEndPoints(){map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)||map.addLayer(possibleFromToEndPoints)}function addLiveStartPoints(){Object.entries(all_places).forEach(e=>{var[,e]=e,t=L.icon({iconUrl:"/static/icons/departure_board.png",iconSize:[24,24],iconAnchor:[12,24]}),t=L.marker([e.place_lat,e.place_lon],{icon:t});t.bindTooltip(decodeURI(e.place_name)),t.properties=e,t.addEventListener("click",_showLiveOnClick),t.addTo(liveStops)})}function addLiveStops(){var e=new XMLHttpRequest;e.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(e=JSON.parse(this.responseText),Object.entries(e).forEach(e=>{var[,e]=e,t=L.icon({iconUrl:"/static/icons/departure_board.png",iconSize:[24,24],iconAnchor:[12,24]}),t=L.marker([e.location.latitude,e.location.longitude],{icon:t});t.bindTooltip(decodeURI(e.name)),t.properties=e,t.addEventListener("click",_showLiveStopsOnClick),t.addTo(liveStops)}))},e.open("GET","/static/stops.json",!0),e.send()}function hideSidepanal(){var e=document.getElementById("mySidepanelLeft");e.classList.contains("opened")&&e.classList.remove("opened"),e.classList.add("closed")}function showSidepanelTab(e){for(var t=document.getElementById("mySidepanelLeft"),a=(t.classList.contains("closed")&&t.classList.remove("closed"),t.classList.add("opened"),document.getElementsByClassName("sidebar-tab-link")),o=0;o<a.length;o++)a[o].classList.contains("active")&&a[o].classList.remove("active");for(o=0;o<a.length;o++)a[o].attributes["data-tab-link"].value!=e||a[o].classList.contains("active")||a[o].classList.add("active");for(a=document.getElementsByClassName("sidepanel-tab-content"),o=0;o<a.length;o++)a[o].classList.contains("active")&&(lastScrollTop[a[o].attributes["data-tab-content"].value]=document.getElementsByClassName("sidepanel-content-wrapper")[0].scrollTop,["tab-travel-details","tab-place"].includes(a[o].attributes["data-tab-content"].value)||(lastTab=a[o].attributes["data-tab-content"].value),a[o].classList.remove("active"));for(o=0;o<a.length;o++)a[o].attributes["data-tab-content"].value!=e||a[o].classList.contains("active")||(a[o].classList.add("active"),e in lastScrollTop?document.getElementsByClassName("sidepanel-content-wrapper")[0].scrollTop=lastScrollTop[e]:document.getElementsByClassName("sidepanel-content-wrapper")[0].scrollTop=0)}function getAgencyLookup(){var e=new XMLHttpRequest;e.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(e=JSON.parse(this.responseText),agencyLookup=e)},e.open("GET","/static/agency_lookup.json",!0),e.send()}function getInspiredTrips(){var e=new XMLHttpRequest;e.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(e=JSON.parse(this.responseText),inspiredTrips=e,Object.entries(inspiredTrips).forEach(e=>{var[e,t]=e,e=`
      <div class="col">
      <div class="card">
        <img src="${t.trip_image}" class="card-img-top" alt="trip image">
        <div class="card-img-overlay">
          <a href="#" class="triptitle" onclick="showInspiredRoute('${e}')">${t.trip_title}</a>
        </div>
        <div class="card-body">
          <p class="card-text">${t.trip_description}</p>
        </div>
      </div>
      </div>
      `;document.getElementById("inspireBody").insertAdjacentHTML("beforeend",e)}))},e.open("GET","/static/trips.json",!0),e.send()}function zoomToPlace(e){place=all_places[e],map.flyTo([place.place_lat,place.place_lon])}function showTripParts(e){document.getElementById("inspireDetailsBody").innerHTML="",document.getElementById("inspireTitle").innerHTML=inspiredTrips[e].trip_title;for(var t=inspiredTrips[e].hops,a=0;a<t.length;a++){place=all_places[t[a].place_id];var o=`
    <div class="card mb-3">
      <img src="${t[a].hop_image}" class="img-fluid rounded-start" alt="hop image" title="${t[a].hop_image_attribution}">
      <div class="card-text">
      <!--<h4 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${place.place_name}</h4>-->
      <a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff";" onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a>
      <p class="card-text">${t[a].hop_description}</p>
      <a target="_blank" href="${t[a].link}">${t[a].link_text}</a>
      </div>
    </div>`;document.getElementById("inspireDetailsBody").insertAdjacentHTML("beforeend",o)}showSidepanelTab("tab-inspire-details")}function showHomeTab(){popup&&popup.close(),map.setView([45,10],5),map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)&&map.removeLayer(fromToStartPoint),map.hasLayer(fromToDestination)&&map.removeLayer(fromToDestination),map.hasLayer(fromToLines)&&map.removeLayer(fromToLines),map.hasLayer(possibleInspiredTrip)&&map.removeLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)&&map.removeLayer(possibleInspiredTripRouteLines),map.hasLayer(liveStops)&&map.removeLayer(liveStops),map.hasLayer(liveRouteLines)&&map.removeLayer(liveRouteLines),0<hops.getLayers().length?(buildSummary(),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)||map.addLayer(possibleHops),map.hasLayer(hops)||map.addLayer(hops),map.hasLayer(routeLines)||map.addLayer(routeLines),document.getElementById("homeWelcome").hidden=!0,document.getElementById("freestyleBody").hidden=!1):(map.hasLayer(freestyleStartPoints)||map.addLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),document.getElementById("homeWelcome").hidden=!1,document.getElementById("freestyleBody").hidden=!0),localStorage.getItem("trips")?(document.getElementById("savedTripDiv").hidden=!1,showSavedTrips()):document.getElementById("savedTripDiv").hidden=!0,showSidepanelTab("tab-home")}function showInspireTab(){popup&&popup.close(),map.setView([45,10],5),map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)&&map.removeLayer(fromToStartPoint),map.hasLayer(fromToDestination)&&map.removeLayer(fromToDestination),map.hasLayer(fromToLines)&&map.removeLayer(fromToLines),map.hasLayer(liveStops)&&map.removeLayer(liveStops),map.hasLayer(liveRouteLines)&&map.removeLayer(liveRouteLines),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),map.hasLayer(possibleInspiredTrip)||map.addLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)||map.addLayer(possibleInspiredTripRouteLines),0==possibleInspiredTrip.getLayers().length&&0<hops.getLayers().length&&(popup_text=`
    <div>
    <div class="card-body">Wondering where your existing trip has gone?
    <br>Just click on the frog at any time to hop back.
    </div>
   </div>`,popup=L.popup().setLatLng([45,10]).setContent(popup_text).openOn(map)),showSidepanelTab("tab-inspire")}function showDestinationTab(){popup&&popup.close(),map.setView([45,10],5),0==fromToLines.getLayers().length?map.hasLayer(possibleFromToStartPoints)||map.addLayer(possibleFromToStartPoints):(map.hasLayer(fromToStartPoint)||map.addLayer(fromToStartPoint),map.hasLayer(fromToDestination)||map.addLayer(fromToDestination),map.hasLayer(fromToLines)||map.addLayer(fromToLines)),map.hasLayer(liveStops)&&map.removeLayer(liveStops),map.hasLayer(liveRouteLines)&&map.removeLayer(liveRouteLines),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),map.hasLayer(possibleInspiredTrip)&&map.removeLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)&&map.removeLayer(possibleInspiredTripRouteLines),showSidepanelTab("tab-destination")}function showLiveTab(){popup&&popup.close(),map.setView([45,10],5),map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)&&map.removeLayer(fromToStartPoint),map.hasLayer(fromToDestination)&&map.removeLayer(fromToDestination),map.hasLayer(fromToLines)&&map.removeLayer(fromToLines),map.hasLayer(liveRouteLines)||map.addLayer(liveRouteLines),map.hasLayer(liveStops)||map.addLayer(liveStops),map.hasLayer(freestyleStartPoints)&&map.removeLayer(freestyleStartPoints),map.hasLayer(possibleHops)&&map.removeLayer(possibleHops),map.hasLayer(hops)&&map.removeLayer(hops),map.hasLayer(routeLines)&&map.removeLayer(routeLines),map.hasLayer(possibleInspiredTrip)&&map.removeLayer(possibleInspiredTrip),map.hasLayer(possibleInspiredTripRouteLines)&&map.removeLayer(possibleInspiredTripRouteLines),showSidepanelTab("tab-live-departures")}function _starterMarkerOnClick(e){hops.clearLayers(),routeLines.clearLayers();var t=L.icon({iconUrl:"/static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),t=L.marker([e.latlng.lat,e.latlng.lng],{icon:t});t.properties=e.sourceTarget.properties,t.properties.hop_count=1,t.bindTooltip(t.properties.place_name),t.addTo(hops),getHops(e.sourceTarget.properties.place_id),showHomeTab(),map.flyTo([e.latlng.lat,e.latlng.lng],5)}function _markerOnClick(e){candidateHop=e.sourceTarget.properties,place=all_places[candidateHop.place_id];var t=get_place_details_block(candidateHop.place_id),t=(document.getElementById("place_body").innerHTML=t,get_travel_details_block(candidateHop.details));document.getElementById("travel_details_body").innerHTML=`<h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${hops.getLayers()[hops.getLayers().length-1].properties.place_name} to ${place.place_name}</h5>`+t,popup_text=`
    <div class="card mb-3">
     <img src="${place.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="${place.place_name}" title = "${place.image_attribution}">
     <div class="card-img-overlay">
       <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-3"><button type="button" class="btn btn-success btn-sm" onclick="_addToTrip()">Add</button></div></div>
     </div>
     <ul class="list-group list-group-flush">
      <li class="list-group-item">${decodeURIComponent(place.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
      <li class="list-group-item">Journey times from: ${format_duration(candidateHop.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>
     </ul>
    </div>`,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _addToTrip(){popup&&popup.close(),hops_items=hops.getLayers(),e=all_places[hops_items[hops_items.length-1].properties.place_id],pointA=new L.LatLng(parseFloat(e.place_lat),parseFloat(e.place_lon)),pointB=new L.LatLng(parseFloat(candidateHop.place_lat),parseFloat(candidateHop.place_lon));var e,t=[pointA,pointB],t=((new_line=new L.Polyline(t,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1})).addTo(routeLines),L.icon({iconUrl:"/static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]})),t=L.marker([parseFloat(candidateHop.place_lat),parseFloat(candidateHop.place_lon)],{icon:t});hop=all_places[candidateHop.place_id],t.properties=hop,t.properties.from_place_id=e.place_id,t.properties.hop_count=hops_items.length+1,t.bindTooltip(hop.place_name),t.addEventListener("click",_hopOnClick),t.addTo(hops),getHops(candidateHop.place_id),buildSummary()}function _hopOnClick(e){var t=e.sourceTarget.properties,a=get_place_details_block((place=all_places[t.place_id]).place_id),a=(document.getElementById("place_body").innerHTML=a,get_travel_details(t.from_place_id,t.place_id)),o=get_travel_details_block(a.details);document.getElementById("travel_details_body").innerHTML=`<h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${all_places[t.from_place_id].place_name} to ${place.place_name}</h5>`+o,popup_text=`
  <div class="card mb-3">
  <img src="${place.place_image}" class="img-fluid rounded-start" alt="${place.place_name}" title = "${place.image_attribution}">
  <div class="card-img-overlay">
    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-4"></div></div>
  </div>
  <ul class="list-group list-group-flush">
   <li class="list-group-item">${decodeURIComponent(place.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
   <li class="list-group-item">Journey times from: ${format_duration(a.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>
  </ul>
 </div>
  `,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _inspireHopOnClick(e){var e=e.sourceTarget.properties,t=get_place_details_block((place=all_places[e.place_id]).place_id),t=(document.getElementById("place_body").innerHTML=t,get_travel_details(e.from_place_id,e.place_id)),a=get_travel_details_block(t.details);document.getElementById("travel_details_body").innerHTML=`<h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${all_places[e.from_place_id].place_name} to ${place.place_name}</h5>`+a,a=e.next_hop_index==possibleInspiredTrip.getLayers().length?`<button class="btn btn-success btn-sm" onclick="customise('${e.trip_id}')">Add hop</button>`:`<button class="btn btn-success btn-sm" onclick="showInspiredHop(${e.next_hop_index})">Next</button>`,popup_text=`

  <div class="card mb-3">
  <img src="${e.hop_image}" class="img-fluid rounded-start" style="max-height:250px" alt="hop image" title = "${e.hop_image_attribution}">
  <div class="card-img-overlay">
    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-4">${a}</div></div>
  </div>
  <ul class="list-group list-group-flush">
   <li class="list-group-item">${e.hop_description} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
   <li class="list-group-item">Journey times from: ${format_duration(t.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>
  </ul>
 </div>
  `,popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function _startInspireHopOnClick(e){var e=e.sourceTarget.properties,t=`<button class="btn btn-success btn-sm" onclick="showInspiredHop(${e.next_hop_index})">Next</button>`,a=get_place_details_block((place=all_places[e.place_id]).place_id);document.getElementById("place_body").innerHTML=a,popup_text=`
  <div class="card mb-3">
  <img src="${e.hop_image}" class="img-fluid rounded-start" style="max-height:250px" alt="hop image" title = "${e.hop_image_attribution}">
  <div class="card-img-overlay">
    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-4">${t}</div></div>
  </div>
  <ul class="list-group list-group-flush">
   <li class="list-group-item">${e.hop_description}</li>
  </ul>
 </div>
    `,popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function showInspiredHop(e){possibleInspiredTrip.getLayers()[e].fireEvent("click")}function get_place_details_block(e){return`<h3 class="offcanvas-title" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${all_places[e].place_name}</h3>
  <div class="card">
    <img src="${all_places[e].place_image}" class="card-img-top" alt="${all_places[e].place_name}" title="all_places[id]["image_attribution"]">
    <div class="card-body">
      <p class="card-text">${all_places[e].place_longer_desc}</p>
	  <a href="${all_places[e].place_links}" target="_blank" class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover">more info</a>
    </div>
    <div class="accordion accordion-flush" id="accordionPlaceDetails">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
            Things to do
          </button>
        </h2>
        <div id="flush-collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
          <div class="accordion-body">
		  <p class="card-text">If you'd like to see what there is to see and do, here are some sites with ideas.</p>
          <ul class="list-group list-group-flush">
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://tripadvisor.tp.st/iaDPCVsJ" target="_blank">TripAdvisor</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://viator.tp.st/dxbdWqWw" target="_blank">Viator</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://getyourguide.tp.st/j1O2V9WC" target="_blank">GetYourGuide</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://gocity.tp.st/bJKfnqLg" target="_blank">Go City</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://bikesbooking.tp.st/hzrEGoUL" target="_blank">BikesBooking.com</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://wegotrip.tp.st/9RusUZKl" target="_blank">WeGoTrip</a></li>
          </ul>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
            Places to stay
          </button>
        </h2>
        <div id="flush-collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
          <div class="accordion-body">
			    <p class="card-text">Here are some links to sites where you can find a place to stay.</p>
          <ul class="list-group list-group-flush">
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://booking.tp.st/JFpi36Ld/" target="_blank">Booking.com</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://vrbo.tp.st/V3hK9T1Z" target="_blank">Vrbo</a></li>
          <li class="list-group-item"><a class="link-dark link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover" href="https://hostelworld.tp.st/kXriQ07L" target="_blank">Hostelworld</a></li>
          </ul>
          </div>
        </div>
      </div>
    </div>
  </div>`}function get_travel_details_block(e){return details_list='<ul class="list-group list-group-flush">',e.forEach(function(e){agency_name=e.agency_name,agency_url=agency_name in agencyLookup?agencyLookup[agency_name]:"https://omio.tp.st/p3bESwp0",transport_type=e.mode,details_list+=`
    <li class="list-group-item">
      <div class="row g-0">
        <div class="col-md-4">
          <img src="/static/icons/${transport_type}.png" class="img-fluid rounded-start" alt="${transport_type}">
        </div>
        <div class="col-md-8">
          <div class="card-body">
            <h5 class="card-title"><a target="_blank" href="${agency_url}" >${agency_name}</a></h5>
            <p class="card-text"><small class="text-body-secondary">Journey time: ${format_duration(e.duration_min)}</small></p>
            </div>
        </div>
      </div>     
    </li>`}),details_list+="</ul>"}function get_travel_details(e,t){var a;return all_hops[e].hops.forEach(e=>{e.place_id==t&&(a=e)}),a}function sortNextHops(e,t){return parseFloat(e.properties.duration_min)<parseFloat(t.properties.duration_min)?-1:parseFloat(e.properties.duration_min)>parseFloat(t.properties.duration_min)?1:0}function getHops(e){possibleHops.clearLayers();e=all_hops[e].hops;Object.entries(e).forEach(e=>{var[,e]=e,t=L.icon({iconUrl:"/static/icons/hop.png",iconSize:[36,36],iconAnchor:[18,36]}),t=L.marker([e.place_lat,e.place_lon],{icon:t});t.bindTooltip(e.place_name+": "+format_duration(e.duration_min)),t.properties=e,t.addEventListener("click",_markerOnClick),t.riseOnHover=!0,t.addTo(possibleHops)})}function removeHop(e){popup&&popup.close();for(var t=hops.getLayers().length,a=e;a<t;a++)h=hops.getLayers(),hops.removeLayer(h[h.length-1]._leaflet_id),layers=routeLines.getLayers(),routeLines.removeLayer(layers[layers.length-1]._leaflet_id);e=(e=hops.getLayers())[e.length-1].properties.place_id;possibleHops.clearLayers(),getHops(e),buildSummary()}function format_duration(e){return remainder=e%60,str_remainder=Math.round(remainder).toString(),(hours=(e-remainder)/60).toString()+":"+str_remainder.padStart(2,"0")}function openTravelDetails(e,t){var a=get_travel_details_block(get_travel_details(e,t).details);document.getElementById("travel_details_body").innerHTML=`<h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${all_places[e].place_name} to ${all_places[t].place_name}</h5>`+a,showSidepanelTab("tab-travel-details")}function openPlaceDetails(e){e=get_place_details_block((place=all_places[e]).place_id);document.getElementById("place_body").innerHTML=e,showSidepanelTab("tab-place")}function showInspiredRoute(e){possibleInspiredTrip.clearLayers(),possibleInspiredTripRouteLines.clearLayers();var t=inspiredTrips[e].hops,a=all_places[t[0].place_id],o=L.icon({iconUrl:"/static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),s=L.marker([parseFloat(a.place_lat),parseFloat(a.place_lon)],{icon:o});s.bindTooltip(decodeURI(a.place_name)),a.hop_image=t[0].hop_image,a.hop_image_attribution=t[0].hop_image_attribution,a.hop_description=t[0].hop_description,a.link=t[0].link,a.link_text=t[0].link_text,a.trip_id=e,a.next_hop_index=1,s.properties=a,s.addEventListener("click",_startInspireHopOnClick),s.riseOnHover=!0,s.addTo(possibleInspiredTrip);for(var i=1;i<t.length;i++){(a=all_places[t[i].place_id]).from_place_id=t[i-1].place_id,a.hop_count=i;var o=L.icon({iconUrl:"/static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]}),l=L.marker([parseFloat(a.place_lat),parseFloat(a.place_lon)],{icon:o}),l=(l.bindTooltip(a.place_name),a.hop_image=t[i].hop_image,a.hop_image_attribution=t[i].hop_image_attribution,a.hop_description=t[i].hop_description,a.link=t[i].link,a.link_text=t[i].link_text,a.trip_id=e,a.next_hop_index=i+1,l.properties=a,l.addEventListener("click",_inspireHopOnClick),l.riseOnHover=!0,l.addTo(possibleInspiredTrip),pointA=new L.LatLng(parseFloat(all_places[t[i-1].place_id].place_lat),parseFloat(all_places[t[i-1].place_id].place_lon)),pointB=new L.LatLng(parseFloat(all_places[t[i].place_id].place_lat),parseFloat(all_places[t[i].place_id].place_lon)),[pointA,pointB]);(new_line=new L.Polyline(l,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1})).addTo(possibleInspiredTripRouteLines)}hideSidepanal(),showTripParts(e)}function customise(e){useThisRoute(e)}function useThisRoute(e){hops.clearLayers(),routeLines.clearLayers(),popup&&popup.close();var t=inspiredTrips[e].hops,a=all_places[t[0].place_id],o=L.icon({iconUrl:"/static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]});(i=L.marker([parseFloat(a.place_lat),parseFloat(a.place_lon)],{icon:o})).bindTooltip(decodeURI(a.place_name)),i.properties=a,i.riseOnHover=!0,i.addTo(hops);for(var s=1;s<t.length;s++){(a=all_places[t[s].place_id]).from_place_id=t[s-1].place_id,a.hop_count=s;var i,o=L.icon({iconUrl:"/static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]}),l=((i=L.marker([parseFloat(a.place_lat),parseFloat(a.place_lon)],{icon:o})).bindTooltip(a.place_name),i.properties=a,i.addEventListener("click",_hopOnClick),i.riseOnHover=!0,i.addTo(hops),pointA=new L.LatLng(parseFloat(all_places[t[s-1].place_id].place_lat),parseFloat(all_places[t[s-1].place_id].place_lon)),pointB=new L.LatLng(parseFloat(all_places[t[s].place_id].place_lat),parseFloat(all_places[t[s].place_id].place_lon)),[pointA,pointB]);(new_line=new L.Polyline(l,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1})).addTo(routeLines)}getHops(t[t.length-1].place_id),possibleInspiredTrip.clearLayers(),possibleInspiredTripRouteLines.clearLayers(),showHomeTab()}function startAgain(){document.getElementById("freestyleBody").innerHTML="",hops.clearLayers(),routeLines.clearLayers(),possibleHops.clearLayers(),showHomeTab()}function buildSummary(){var a=hops.getLayers();document.getElementById("freestyleBody").innerHTML=`
  <div class="row justify-content-evenly">
    <div class="col-7">
      <h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">Starting at ${a[0].properties.place_name}</h5></div><div class="col" style="float: right;"><img src="/static/icons/save.png" onclick="checkSavingConsent()" title="save" alt="save">  <img src="/static/icons/delete.png" onclick="startAgain()" title="start again" alt="start again"> <small id="tripMessage"></small>
    </div>
    <div id="consentSection" hidden="true">This will save the trip to your device but not be shared with anyone else. Are you happy to proceed? <button class="btn btn-secondary btn-sm" onclick="giveConsent()">OK</button><button onclick="refuseConsent()" class="btn btn-secondary btn-sm">Not OK</button></div>
  </div>`;for(let t=1;t<a.length;t++){let e="";t==a.length-1&&(e=`<button class="btn btn-danger btn-sm" onclick="removeHop('${t}')">remove</button>`),document.getElementById("freestyleBody").innerHTML+=`
    <div class="card border-light mb-3 ">
    <div class="row g-0">
      <div class="col-md-12">
        <img src="/static/icons/train.png" class="img-fluid rounded-start" alt="train">
        <a href="#" class="link-dark link-offset-2" onclick="openTravelDetails('${a[t-1].properties.place_id}','${a[t].properties.place_id}')">${a[t-1].properties.place_name} to ${a[t].properties.place_name} travel options</a>
       </div>
    </div>
  </div>`,document.getElementById("freestyleBody").innerHTML+=`
    <div class="card">
     <img src="${a[t].properties.place_image}" class="img-fluid rounded-start" alt="hop image" title = "${a[t].properties.image_attribution}" onclick="popAndZoom('${a[t].properties.place_id}')">
     <div class="card-img-overlay">
     <div class="row justify-content-evenly"><div class="col"><a href="#" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="popAndZoom('${a[t].properties.place_id}')">${a[t].properties.place_name}</a></div><div class="col-4">${e}</div></div>
    </div>
    </div>`}1==a.length&&(document.getElementById("freestyleBody").innerHTML+=`<h6 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff" >Where next?</h6>
    <p class="text-center">Pick a place to hop to from ${a[0].properties.place_name}.</p>`);var t=possibleHops.getLayers();t.sort(sortNextHops);let o='<div class="card"><div class="card-header">Where next?</div><div class="card-body">';for(let e=0;e<t.length;e++)o+=`
      <div class="row justify-content-evenly">
      <div class="col">   
        <a href="#" onclick="popupHop('${t[e].properties.place_id}')">${t[e].properties.place_name}</a>
      </div>
      <div class="col">   
        <a href="#" onclick="openTravelDetails('${a[a.length-1].properties.place_id}','${t[e].properties.place_id}')">travel time: ${format_duration(Math.round(t[e].properties.duration_min))}</a>
      </div>    
      </div>`;o+="</div></div>",document.getElementById("freestyleBody").insertAdjacentHTML("beforeend",o)}function popAndZoom(e){zoomToPlace(e),openPlaceDetails(e)}function showWholeInspiredRoute(){map.fitBounds([possibleInspiredTrip.getLayers()[0].getLatLng(),possibleInspiredTrip.getLayers()[possibleInspiredTrip.getLayers().length-1].getLatLng()])}function showWholeMap(){map.fitBounds(possibleHops)}function popupHop(t){var a=possibleHops.getLayers();for(let e=0;e<a.length;e++)a[e].properties.place_id==t&&(candidateHop=a[e].properties);place=all_places[candidateHop.place_id];var e=get_place_details_block(candidateHop.place_id),e=(document.getElementById("place_body").innerHTML=e,get_travel_details_block(candidateHop.details));document.getElementById("travel_details_body").innerHTML=`<h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${hops.getLayers()[hops.getLayers().length-1].properties.place_name} to ${place.place_name}</h5>`+e,popup_text=`
    <div class="card mb-3">
     <img src="${place.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="place image" title = "${place.image_attribution}">
     <div class="card-img-overlay">
       <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div><div class="col-3"><button type="button" class="btn btn-success btn-sm" onclick="_addToTrip()">Add</button></div></div>
     </div>
     <ul class="list-group list-group-flush">
      <li class="list-group-item">${decodeURIComponent(place.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
      <li class="list-group-item">Journey times from: ${format_duration(candidateHop.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>
     </ul>
    </div>`,hideSidepanal(),popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function _fromMarkerOnClick(e){candidateHop=e.sourceTarget.properties,place=all_places[candidateHop.place_id];var t=get_place_details_block(candidateHop.place_id);document.getElementById("place_body").innerHTML=t,popup_text=`
        <p>${place.place_name}</p>
        <button type="button" style="background-color:#abc837ff" class="btn btn-success btn-sm" onclick="_setStartpoint('${place.place_id}')">Start here</button>`,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _destinationMarkerOnClick(e){candidateHop=e.sourceTarget.properties,place=all_places[candidateHop.place_id];var t=get_place_details_block(candidateHop.place_id);document.getElementById("place_body").innerHTML=t,popup_text=`
      <p>${place.place_name}</p>
      <button type="button" style="background-color:#abc837ff" class="btn btn-success btn-sm" onclick="_setDestination('${place.place_id}')">Destination</button>`,popup=L.popup().setLatLng([e.latlng.lat,e.latlng.lng]).setContent(popup_text).openOn(map)}function _setStartpoint(e){popup&&popup.close(),map.removeLayer(possibleFromToStartPoints),map.addLayer(possibleFromToEndPoints),startSelect.setSelected(e)}function _setDestination(e){popup&&popup.close(),destinationSelect.setSelected(e),findFabRoutes()}function _routeHopOnClick(e){var e=e.sourceTarget.properties,t=get_place_details_block((place=all_places[e.place_id]).place_id),t=(document.getElementById("place_body").innerHTML=t,get_travel_details(e.from_place_id,e.place_id)),a=get_travel_details_block(t.details);document.getElementById("travel_details_body").innerHTML=`<h5 style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:#ff6600ff">${all_places[e.from_place_id].place_name} to ${place.place_name}</h5>`+a,popup_text=`
  <div class="card mb-3">
  <img src="${e.hop_image}" class="img-fluid rounded-start" style="max-height:250px" alt="hop image" title = "${e.hop_image_attribution}">
  <div class="card-img-overlay">
    <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${place.place_id}')">${place.place_name}</a></div></div>
  </div>
  <ul class="list-group list-group-flush">
   <li class="list-group-item">${e.hop_description} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
   <li class="list-group-item">Journey times from: ${format_duration(t.duration_min)} <a href="#" onclick="showSidepanelTab('tab-travel-details')"> more...</a></li>
  </ul>
 </div>
  `,popup=L.popup().setLatLng([place.place_lat,place.place_lon]).setContent(popup_text).openOn(map)}function clearAllLayers(){hops.clearLayers(),fromToStartPoint.clearLayers(),fromToDestination.clearLayers(),routeLines.clearLayers(),possibleInspiredTrip.clearLayers(),possibleInspiredTripRouteLines.clearLayers(),possibleHops.clearLayers(),freestyleStartPoints.clearLayers(),possibleFromToStartPoints.clearLayers(),possibleFromToEndPoints.clearLayers(),liveRouteLines.clearLayers(),liveStops.clearLayers()}function toRadians(e){return e*(Math.PI/180)}function distanceBetweenTwoPoints(e,t,o,s){return from_lat_rad=toRadians(parseFloat(e)),from_lon_rad=toRadians(parseFloat(t)),to_lat_rad=toRadians(parseFloat(o)),to_lon_rad=toRadians(parseFloat(s)),dist_lon=to_lon_rad-from_lon_rad,dist_lat=to_lat_rad-from_lat_rad,a=Math.sin(dist_lat/2)**2+Math.cos(from_lat_rad)*Math.cos(to_lat_rad)*Math.sin(dist_lon/2)**2,c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)),R=6373,distance=R*c}function findFabRoutes(){popup&&popup.close();var t=document.getElementById("startSelect").value,a=document.getElementById("destinationSelect").value;if(t==a||""==t||""==a)console.log("dodgy "+t);else{map.hasLayer(possibleFromToStartPoints)&&map.removeLayer(possibleFromToStartPoints),map.hasLayer(possibleFromToEndPoints)&&map.removeLayer(possibleFromToEndPoints),map.hasLayer(fromToStartPoint)||map.addLayer(fromToStartPoint),map.hasLayer(fromToDestination)||map.addLayer(fromToDestination),map.hasLayer(fromToLines)||map.addLayer(fromToLines),fromToStartPoint.clearLayers(),fromToDestination.clearLayers(),fromToLines.clearLayers(),document.getElementById("fromToResults").innerHTML="";var o=L.icon({iconUrl:"/static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]});let e=L.marker([all_places[t].place_lat,all_places[t].place_lon],{icon:o});e.properties=all_places[t],e.bindTooltip(e.properties.place_name),e.addTo(fromToStartPoint),o=L.icon({iconUrl:"/static/icons/destination.png",iconSize:[36,36],iconAnchor:[18,36]}),(e=L.marker([all_places[a].place_lat,all_places[a].place_lon],{icon:o})).properties=all_places[a],e.bindTooltip(e.properties.place_name),e.addTo(fromToDestination),getJourneysWithoutDuplicates(t,a)}}function findFromStops(o,s){let i=[];var e=all_places[o],e=`https://${dbServer}/stops/nearby?latitude=${e.place_lat}&longitude=${e.place_lon}&results=1&distance=${e.lat_lon_tolerance}000&stops=true`,t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){for(var e=JSON.parse(this.responseText),t=0;t<e.length;t++){var a=e[t];"stop"==a.type&&(stopsPlacesLookup[a.id]=o,console.log(`findFromStops: ${a.id} - `+a.name),i.push(a.id))}findToStops(o,s,i[0])}else console.log(`Status: ${this.status} 
 Response text: `+this.responseText),document.getElementById("fromToResults").innerHTML="hmm, something went wrong... maybe time to put the kettle on"},t.open("GET",e,!0),t.send()}function findToStops(o,s,i){let l=[];var e=all_places[s],e=`https://${dbServer}/stops/nearby?latitude=${e.place_lat}&longitude=${e.place_lon}&results=1&distance=${e.lat_lon_tolerance}000&stops=true`,t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){for(var e=JSON.parse(this.responseText),t=0;t<e.length;t++){var a=e[t];"stop"==a.type&&(stopsPlacesLookup[a.id]=s,console.log(`findToStops: ${a.id} - `+a.name),l.push(a.id))}getJourneysByStop(o,s,i,l[0])}else console.log(`Status: ${this.status} 
 Response text: `+this.responseText),document.getElementById("fromToResults").innerHTML="hmm, something went wrong... maybe time to put the kettle on"},t.open("GET",e,!0),t.send()}function getFromTo(p,c,d,m){trips={};var e=`https://${dbServer}/journeys?from=${d}&to=${m}&results=3&stopovers=false&transferTime=0&bike=false&startWithWalking=true&walkingSpeed=normal&tickets=false&polylines=false&subStops=true&entrances=true&remarks=true&scheduledDays=false&language=en&firstClass=false`,t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var e=JSON.parse(this.responseText),t=(console.log("processing journeys"),e.journeys),a=(journeyLookup={journeyCount:t.length,lastTripId:null},[]);if(0==t.length)document.getElementById("fromToResults").innerHTML="No results found";else for(var o=0;o<t.length;o++){var s=t[o].legs;let e="";for(var i,l=0;l<s.length;l++)"line"in s[l]&&(i=s[l].line.name,e+=i);if(a.includes(e))console.log("already included this journey");else{console.log("new journey "+e),document.getElementById("fromToResults").insertAdjacentHTML("beforeend",`<div id="${d}_${m}_${o}"></div>`),document.getElementById(d+`_${m}_`+o).insertAdjacentHTML("beforeend",`<h5>Option ${o+1}</h5>`);for(var n,r,l=0;l<s.length;l++)placeNear(s[l].destination.location.latitude,s[l].destination.location.longitude,p)?console.log(s[l].destination.name+` ${p} haven't left start`):placeNear(s[l].origin.location.latitude,s[l].origin.location.longitude,c)?console.log("already reached destination"):"line"in s[l]&&(n=s[l].line.name,e+=n,r=s[l].tripId,n)&&(document.getElementById(d+`_${m}_`+o).insertAdjacentHTML("beforeend",`<div id="${s[l].origin.id}_${s[l].destination.id}_${o}"></div>`),getTripsForLine(s[l].origin.id,s[l].destination.id,r,n,`${s[l].origin.id}_${s[l].destination.id}_`+o),journeyLookup.lastTripId=r)}}}else console.log(`Status: ${this.status} 
 Response text: `+this.responseText),document.getElementById("fromToResults").innerHTML="hmm, something went wrong... maybe time to put the kettle on"},t.open("GET",e,!0),t.send()}function getTripsForLine(c,d,m,e,u){var t=`https://${dbServer}/trips/${encodeURIComponent(m)}?lineName=`+encodeURIComponent(e),a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var o=JSON.parse(this.responseText);if(trips[encodeURIComponent(m)]=o,console.log(`processing trip from ${c} to `+d),console.log(e),"stopovers"in o){let s=o.stopovers,t="";if(o.remarks)for(let e=0;e<o.remarks.length;e++)t+="<br>"+o.remarks[e].text;let e="",a=!1,i,l;var r=[];let n=[];for(let o=0;o<s.length;o++){if(0!=o&&s[o].plannedArrival?s[o].timestamp=s[o].plannedArrival:s[o].timestamp=s[o].plannedDeparture,s[o].stop.id==c&&(a=!0,i=o),a){let t="",a=`showPlaceOnMap('${s[o].stop.location.latitude}', '${s[o].stop.location.longitude}','${s[o].stop.name}')`;Object.entries(all_places).forEach(e=>{var[,e]=e;distanceBetweenTwoPoints(s[o].stop.location.latitude,s[o].stop.location.longitude,e.place_lat,e.place_lon)<=e.lat_lon_tolerance&&(a=`popupPlace('${e.place_id}')`,n.includes(e.place_id)||n.push(e.place_id),t='<span class="badge text-bg-light">Fab Hop!</span>')}),e+=`<li class="list-group-item"><a href="#" onclick="${a}">${s[o].stop.name} ${t}</a></li>`,r.push([s[o].stop.location.latitude,s[o].stop.location.longitude])}s[o].stop.id==d&&(l=o,a=!1)}badge=1<n.length?`<span class="badge text-bg-light">${n.length} fab hops!</span>`:1==n.length?'<span class="badge text-bg-light">1 fab hop!</span>':"";var p=`
            <div class="card">
              <div class="card-header">
              <img src="/static/icons/${o.line.mode}.png" class="img-fluid rounded-start" alt="${o.line.mode}"> <a data-bs-toggle="collapse" href="#${encodeURIComponent(m)}" aria-expanded="false" aria-controls="${encodeURIComponent(m)}">
              ${s[i].stop.name} to ${s[l].stop.name}
              </a> ${badge}
              </div>
              <div class="collapse" id="${encodeURIComponent(m)}">
              <div class="card-body">
              <ul class="list-group list-group-flush">
            `,p=(document.getElementById(u).insertAdjacentHTML("beforeend",p+e+"</ul></div></div></div>"),L.polyline(r,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1}));p.bindTooltip(o.origin.name+" to "+o.destination.name),p.properties=o,p.addTo(fromToLines)}}else console.log(`Status: ${this.status} 
 Response text: `+this.responseText),document.getElementById("fromToResults").innerHTML="hmm, something went wrong... maybe time to put the kettle on"},a.open("GET",t,!0),a.send()}async function getJourneysWithoutDuplicates(o,s){let a=[],c,d;if(o in stopsForPlaces&&s in stopsForPlaces&&0<stopsForPlaces[o].length&&0<stopsForPlaces[s].length){c=stopsForPlaces[o][0].id,d=stopsForPlaces[s][0].id;var e=`https://${dbServer}/journeys?from=${c}&to=${d}&results=3&stopovers=false&transferTime=0&bike=false&startWithWalking=true&walkingSpeed=normal&tickets=false&polylines=false&subStops=true&entrances=true&remarks=true&scheduledDays=false&language=en&firstClass=false`,e=await fetch(e);if(200==e.status){var i=(await e.json()).journeys;for(let e=0;e<i.length;e++){var l={from_stop_id:c,to_stop_id:d,legs:[]},n=i[e].legs;for(let a=0;a<n.length;a++)if(placeNear(n[a].destination.location.latitude,n[a].destination.location.longitude,o))console.log(n[a].destination.name+` ${o} haven't left start`);else if(placeNear(n[a].origin.location.latitude,n[a].origin.location.longitude,s))console.log("already reached destination");else if("line"in n[a]){var r=n[a].line.name,p=n[a].tripId;if(r){p=`https://${dbServer}/trips/${encodeURIComponent(p)}?lineName=`+encodeURIComponent(r),r=await(await fetch(p)).json();if("stopovers"in r){var m={stops:[]},u=r.stopovers;let t=!1;for(let e=0;e<u.length;e++)0!=e&&u[e].plannedArrival?u[e].timestamp=u[e].plannedArrival:u[e].timestamp=u[e].plannedDeparture,u[e].stop.id==n[a].origin.id&&(t=!0,e),t&&m.stops.push({name:u[e].stop.name,latitude:u[e].stop.location.latitude,longitude:u[e].stop.location.longitude}),u[e].stop.id==n[a].destination.id&&(e,t=!1,l.legs.push(m))}}}var h=JSON.stringify(l);let t=!0;for(let e=0;e<a.length;e++)a[e]==h&&(t=!1,console.log("found duplicate footprint"));if(t){a.push(h),console.log(h);let r=a.length,p=(document.getElementById("fromToResults").insertAdjacentHTML("beforeend",`<div id="${c}_${d}_${r}"></div>`),document.getElementById(`${c}_${d}_`+r).insertAdjacentHTML("beforeend",`<h5>Option ${r}</h5>`),0);l.legs.forEach(e=>{p++;var s=[];let i=[];var t=e.stops[0].name,a=e.stops[e.stops.length-1].name;let l="",n=e.stops;for(let o=0;o<n.length;o++){let t="",a=`showPlaceOnMap('${n[o].latitude}', '${n[o].longitude}','${n[o].name}')`;Object.entries(all_places).forEach(e=>{var[,e]=e;distanceBetweenTwoPoints(n[o].latitude,n[o].longitude,e.place_lat,e.place_lon)<=e.lat_lon_tolerance&&(a=`popupPlace('${e.place_id}')`,i.includes(e.place_id)||i.push(e.place_id),t='<span class="badge text-bg-light">Fab Hop!</span>')}),l+=`<li class="list-group-item"><a href="#" onclick="${a}">${n[o].name} ${t}</a></li>`,s.push([n[o].latitude,n[o].longitude])}badge=1<i.length?`<span class="badge text-bg-light">${i.length} fab hops!</span>`:1==i.length?'<span class="badge text-bg-light">1 fab hop!</span>':"";var o=`<div>
              ${`
              <div class="card">
                <div class="card-header">
                <img src="/static/icons/train.png" class="img-fluid rounded-start" alt="train"> <a data-bs-toggle="collapse" href="#journey_details_${r}_${p}" aria-expanded="false" aria-controls="journey_details_${r}_${p}">
                ${t} to ${a}
                </a> ${badge}
                </div>
                <div class="collapse" id="journey_details_${r}_${p}">
                <div class="card-body">
                <ul class="list-group list-group-flush">
              `}${l}</ul></div></div>
              </div>`,o=(document.getElementById(`${c}_${d}_`+r).insertAdjacentHTML("beforeend",o),L.polyline(s,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1}));o.bindTooltip(t+" to "+a),o.properties=e,o.addTo(fromToLines)})}}}}}function getDepartures(o){liveRouteLines.clearLayers(),map.hasLayer(liveRouteLines)||map.addLayer(liveRouteLines);var e=stopsPlacesLookup[o],e=(all_places[e],trips={},`https://${dbServer}/stops/${o}/departures?duration=1440`),t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var e=JSON.parse(this.responseText);console.log("processing departures"),console.log(this.responseText);for(var t=0;t<e.length;t++){var a=e[t];trip_id=a.tripId,line_name=a.line.name,getLiveTrips(o,trip_id,line_name)}}else console.log(`Status: ${this.status} 
 Response text: `+this.responseText),document.getElementById("fromToResults").innerHTML="hmm, something went wrong... maybe time to put the kettle on"},t.open("GET",e,!0),t.send()}function getLiveTrips(p,c,e){var e=`https://${dbServer}/trips/${encodeURIComponent(c)}?lineName=`+encodeURIComponent(e),t=new XMLHttpRequest;t.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var o=JSON.parse(this.responseText);if(trips[encodeURIComponent(c)]=o,console.log("processing trips"),console.log(this.responseText),"stopovers"in o){let s=o.stopovers,t="";if(o.remarks)for(let e=0;e<o.remarks.length;e++)t+="<br>"+o.remarks[e].text;let e="",a=!1,i;var n,r=[];let l=[];for(let o=0;o<s.length;o++){s[o].stop.id==p&&(a=!0,i=o);if(0!=o&&s[o].plannedArrival?s[o].timestamp=s[o].plannedArrival:s[o].timestamp=s[o].plannedDeparture,a){let t="",a=`showPlaceOnMap('${s[o].stop.location.latitude}', '${s[o].stop.location.longitude}','${s[o].stop.name}')`;Object.entries(all_places).forEach(e=>{var[,e]=e;distanceBetweenTwoPoints(s[o].stop.location.latitude,s[o].stop.location.longitude,e.place_lat,e.place_lon)<=e.lat_lon_tolerance&&(a=`popupPlace('${e.place_id}')`,l.includes(e.place_id)||l.push(e.place_id),t='<span class="badge text-bg-light">Fab Hop!</span>')}),e+=`<li class="list-group-item">${s[o].timestamp.substring(11,19)}: <a href="#" onclick="showPlaceOnMap('${s[o].stop.location.latitude}', '${s[o].stop.location.longitude}','${s[o].stop.name}')">${s[o].stop.name}</a></li>`,r.push([s[o].stop.location.latitude,s[o].stop.location.longitude])}}a&&(badge=1<l.length?`<span class="badge text-bg-light">${l.length} fab hops!</span>`:1==l.length?'<span class="badge text-bg-light">1 fab hop!</span>':"",n=`
            <div class="card">
            <div class="card-header livetrip" onmouseover="showTripOnMap('${encodeURIComponent(c)}')" timestamp="${s[i].timestamp.substring(11,19)}">
            ${s[i].timestamp.substring(11,19)} 
            <a data-bs-toggle="collapse" href="#${encodeURIComponent(c)}" aria-expanded="false" aria-controls="${encodeURIComponent(c)}">
            ${s[i].stop.name} to ${o.destination.name}
            </a> ${badge}
            </div>
            <div class="collapse" id="${encodeURIComponent(c)}">
            <div class="card-body">
            <p>${o.line.mode}
            ${t}
            </p>
            <ul class="list-group list-group-flush">
            `,document.getElementById("routes_from_places").insertAdjacentHTML("beforeend",n+e+"</ul></div></div></div>"),(n=L.polyline(r,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1})).bindTooltip(o.origin.name+" to "+o.destination.name),n.properties=o,n.addTo(liveRouteLines))}}else console.log(`Status: ${this.status} 
 Response text: `+this.responseText),document.getElementById("fromToResults").innerHTML="hmm, something went wrong... maybe time to put the kettle on"},t.open("GET",e,!0),t.send()}function sortTimetable(){document.getElementsByClassName("livetrip").sort(function(e,t){return e.getAttribute("timestamp")<t.getAttribute("timestamp")?-1:1}),document.getElementById("routes_from_places").html(divList)}function showPlaceOnMap(t,a,e){let o="";Object.entries(all_places).forEach(e=>{var[,e]=e;distanceBetweenTwoPoints(t,a,e.place_lat,e.place_lon)<=e.lat_lon_tolerance&&(o=`<a href="#" onclick="popupPlace('${e.place_id}')">more...</a>`)});e=`<p>${e}<br>${o}</p>`;popup=L.popup().setLatLng([t,a]).setContent(e).openOn(map)}function showTripOnMap(e){e=trips[e];if("stopovers"in e){var a=e.stopovers;departureTime=a[0].plannedDeparture,latlngs=[];for(let t=0;t<a.length;t++){let e="";e=(e=a[t].departure?a[t].departure:e)||a[t].arrival,latlngs.push([a[t].stop.location.latitude,a[t].stop.location.longitude])}var t=L.polyline(latlngs,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1});t.bindTooltip(e.origin.name+" to "+e.destination.name),t.properties=e,t.addTo(liveRouteLines)}}function _showLiveStopsOnClick(e){document.getElementById("routes_from_places").innerHTML="";var t=`<h5>Departures from ${e.sourceTarget.properties.name}</h5>`;document.getElementById("routes_from_places").insertAdjacentHTML("beforeend",t),getDepartures(e.sourceTarget.properties.id)}function _showLiveOnClick(e){document.getElementById("routes_from_places").innerHTML="",place_id=e.sourceTarget.properties.place_id;e=`<h5>Departures from ${(place=all_places[place_id]).place_name}</h5>`;document.getElementById("routes_from_places").insertAdjacentHTML("beforeend",e),stopsForPlaces.forEach(e=>{stopsPlacesLookup[e.id]=place_id,getDepartures(e.id)})}function popupPlace(e){var t=all_places[e],e=get_place_details_block(e);document.getElementById("place_body").innerHTML=e,popup_text=`
    <div class="card mb-3">
     <img src="${t.place_image}" class="img-fluid rounded-start" style="max-height:250px" alt="place image" title="${t.image_attribution}" alt="${t.place_name}">
     <div class="card-img-overlay">
       <div class="row justify-content-evenly"><div class="col"><a href="#" class="h3" style="font-family: 'Cantora One', Arial; font-weight: 700; vertical-align: baseline; color:white; text-shadow:-1px 1px 0 #000, 1px 1px 0 #000; " onclick="openPlaceDetails('${t.place_id}')">${t.place_name}</a></div></div>
     </div>
     <ul class="list-group list-group-flush">
      <li class="list-group-item">${decodeURIComponent(t.place_brief_desc)} <a href="#" onclick="showSidepanelTab('tab-place')"> more...</a></li>
     </ul>
    </div>`,hideSidepanal(),popup=L.popup().setLatLng([t.place_lat,t.place_lon]).setContent(popup_text).openOn(map)}function placeNear(e,t,a){a=all_places[a];return distanceBetweenTwoPoints(e,t,a.place_lat,a.place_lon)<=a.lat_lon_tolerance}function revertToPreviousTab(){showSidepanelTab(lastTab)}function giveConsent(){localStorage.setItem("savingConsentGiven",!0),document.getElementById("consentSection").hidden=!0,saveTrip()}function refuseConsent(){document.getElementById("consentSection").hidden=!0}function checkSavingConsent(){localStorage.getItem("savingConsentGiven")?saveTrip():document.getElementById("consentSection").hidden=!1}function saveTrip(){let t=[],a=[];hops.getLayers().forEach(e=>{t.push(e.properties.place_id),a.push(e.properties.place_name)});var e,o=t.join("-"),s={ids:t,names:a};localStorage.getItem("trips")?(tripString=localStorage.getItem("trips"),(trips=JSON.parse(tripString))[o]=s,localStorage.setItem("trips",JSON.stringify(trips))):((e={})[o]=s,localStorage.setItem("trips",JSON.stringify(e))),document.getElementById("tripMessage").innerHTML="saved",setTimeout(()=>{document.getElementById("tripMessage").innerHTML=""},3e3),showSavedTrips()}function deleteSavedTrip(e){tripString=localStorage.getItem("trips"),delete(trips=JSON.parse(tripString))[e],tripString=JSON.stringify(trips),localStorage.setItem("trips",tripString),showSavedTrips()}function showSavedTrips(){document.getElementById("savedTripList").innerHTML='<ul class="list-group list-group-flush"></ul>',tripString=localStorage.getItem("trips"),trips=JSON.parse(tripString),Object.entries(trips).forEach(e=>{var[e,t]=e,t=t.names;summary=`<li class="list-group-item"><a href="#" onclick="showSavedTrip('${e}')">${t.join(" > ")}</a> <img src="/static/icons/delete.png" onclick="deleteSavedTrip('${e}')" title="remove" alt="remove"></li>`,document.getElementById("savedTripList").insertAdjacentHTML("beforeend",summary)})}function showSavedTrip(e){var t=localStorage.getItem("trips"),a=JSON.parse(t)[e].ids;hops.clearLayers(),routeLines.clearLayers(),place=all_places[a[0]],my_icon=L.icon({iconUrl:"/static/icons/home.png",iconSize:[36,36],iconAnchor:[18,36]}),(marker=L.marker([place.place_lat,place.place_lon],{icon:my_icon})).properties=place,marker.properties.hop_count=1,marker.bindTooltip(place.place_name),marker.addTo(hops);for(let e=1;e<a.length;e++){thisHop=all_places[a[e]],lastHop=all_places[a[e-1]],pointA=new L.LatLng(parseFloat(lastHop.place_lat),parseFloat(lastHop.place_lon)),pointB=new L.LatLng(parseFloat(thisHop.place_lat),parseFloat(thisHop.place_lon));var o=[pointA,pointB];(new_line=new L.Polyline(o,{color:"#ff6600ff",weight:3,opacity:.5,smoothFactor:1})).addTo(routeLines),my_icon=L.icon({iconUrl:"/static/icons/triphop.png",iconSize:[24,24],iconAnchor:[12,24]}),(marker=L.marker([parseFloat(thisHop.place_lat),parseFloat(thisHop.place_lon)],{icon:my_icon})).properties=thisHop,marker.properties.from_place_id=lastHop.place_id,marker.properties.hop_count=e+1,marker.bindTooltip(thisHop.place_name),marker.addEventListener("click",_hopOnClick),marker.addTo(hops)}getHops(a[a.length-1]),buildSummary(),showHomeTab(),document.getElementsByClassName("sidepanel-content-wrapper")[0].scrollTop=0}